<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>CREMA ‚Ä¢ Turni settimanali (manager)</title>

  <style>
    :root{
      --bg: #f1e4b2;
      --card: #ffffff;
      --ink: #121826;
      --muted:#667085;
      --primary:#ee7523;
      --primary-600:#ee7523;
      --navy:#6a3f24;
      --off:#f8fafc;
      --accent:#fdecc8;
      --border:#e5e7eb;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: system-ui, -apple-system, "Segoe UI", Roboto, Ubuntu, Cantarell, "Noto Sans", "Helvetica Neue", Arial;
      color:var(--ink);
      background: var(--bg);
    }
    .wrap{max-width:1180px;margin:32px auto;padding:0 16px}
    .card{
      background:var(--card);
      border-radius:28px;
      box-shadow: 0 10px 30px rgba(2,6,23,.08);
      padding:24px 20px 28px;
      position:relative;
      overflow:hidden;
    }
    h1{margin:8px 0 4px; font-size: clamp(22px, 3.2vw, 36px);}
    .subtitle{color:var(--muted); font-size:14px; max-width:70ch}

    .toolbar{display:flex;gap:12px;align-items:center;flex-wrap:wrap;margin:14px 0 6px}
    .btn{background:#111827;color:#fff;border:0;border-radius:999px;padding:10px 14px;font-weight:600;cursor:pointer}
    .btn.secondary{background:var(--primary)}
    .switch{display:inline-flex;align-items:center;gap:8px}
    .hint{color:var(--muted);font-size:12px;margin-left:auto}

    .table-wrap{margin-top:18px; border-radius:16px; overflow:auto; border:1px solid var(--border)}
    table{border-collapse:separate; border-spacing:0; width:100%; min-width:980px}
    thead th{position:sticky; top:0; z-index:2; background:var(--primary-600); color:white; font-weight:600; font-size:14px; padding:14px 12px; text-align:left}
    thead th:first-child{background:var(--navy)}
    tbody td{background:#fff; padding:14px 12px; border-bottom:1px solid var(--border); font-size:15px}
    tbody tr:last-child td{border-bottom:none}
    tbody td.off{background:var(--accent)}
    .right{text-align:right}

    .emp{display:flex; align-items:center; gap:12px}
    .avatar{--s:34px; width:var(--s); height:var(--s); border-radius:999px; background:linear-gradient(135deg,#ffd3a8,#ee7523); display:grid; place-items:center; font-weight:700; color:#0b1324}
    .emp .name{font-weight:700}
    .emp small{display:block; color:var(--muted); font-size:12px; margin-top:2px}

    td[contenteditable="true"]{outline:none}
    td.edited{box-shadow:inset 0 0 0 2px #f59e0b;border-radius:6px}
    .tag{display:inline-block;padding:.25rem .5rem;border-radius:999px;border:1px solid var(--border);font-size:12px;color:#111827;margin:2px}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>Programmazione turni settimanale</h1>
      <p class="subtitle">Il manager pu√≤ modificare giorno/ora o impostare <b>OFF</b>. La colonna finale mostra il <b>totale ore</b> settimanali. Sotto vedi i colleghi di turno per un giorno.</p>

      <div class="toolbar">
        <label class="switch"><input type="checkbox" id="managerMode"> Modalit√† manager</label>
        <input type="date" id="weekStart"/>
        <button class="btn" id="prevW">‚óÄ Settimana prec.</button>
        <button class="btn secondary" id="thisW">Questa settimana</button>
        <button class="btn" id="nextW">Settimana succ. ‚ñ∂</button>
        <button class="btn" id="saveBtn" disabled>üíæ Salva modifiche</button>
        <span class="hint">Formato celle: <b>HH:MM-HH:MM</b> o <b>OFF</b>. Doppio clic per alternare OFF.</span>
      </div>

      <div class="table-wrap">
        <table id="schedule">
          <thead>
            <tr>
              <th style="min-width:220px">Dipendente</th>
              <th>Lun</th><th>Mar</th><th>Mer</th><th>Gio</th><th>Ven</th><th>Sab</th><th>Dom</th>
              <th class="right">Totale ore</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>

      <div class="card" style="margin-top:20px">
        <h3>Colleghi di turno</h3>
        <div style="display:flex;gap:12px;align-items:center;margin-bottom:8px">
          <label for="matesDay">Giorno:</label>
          <select id="matesDay">
            <option value="0">Luned√¨</option>
            <option value="1">Marted√¨</option>
            <option value="2">Mercoled√¨</option>
            <option value="3">Gioved√¨</option>
            <option value="4">Venerd√¨</option>
            <option value="5">Sabato</option>
            <option value="6">Domenica</option>
          </select>
        </div>
        <div><strong>Banco</strong>: <span id="mates-banco">‚Äî</span></div>
        <div><strong>Laboratorio</strong>: <span id="mates-lab">‚Äî</span></div>
      </div>
    </div>
  </div>

<!-- Supabase -->
<script type="module">
  import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm";

  // ==== CONFIG SUPABASE ====
  const SUPABASE_URL = "https://tcfmeggqhxcnihkmnkqs.supabase.co";
  const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRjZm1lZ2dxaHhjbmloa21ua3FzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTcxOTAzMjUsImV4cCI6MjA3Mjc2NjMyNX0.VYkrvIVWti57W9UOnQcCvywmonWGyrtIT4KAzszbiFs";
  // ‚ö†Ô∏è No pongas la service key en el front.

  const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  // ==== DOM refs ====
  const tbody = document.querySelector('#schedule tbody');
  const managerMode = document.getElementById('managerMode');
  const saveBtn = document.getElementById('saveBtn');
  const weekStartInp = document.getElementById('weekStart');
  const matesDaySel = document.getElementById('matesDay');
  const matesBanco = document.getElementById('mates-banco');
  const matesLab = document.getElementById('mates-lab');

  // ==== Utils fecha/horas ====
  function toISO(d){ return d.toISOString().slice(0,10); }
  function addDays(d,n){ const x=new Date(d); x.setDate(x.getDate()+n); return x; }
  function startOfWeek(d){ const x=new Date(d); const w=(x.getDay()+6)%7; x.setDate(x.getDate()-w); x.setHours(0,0,0,0); return x; }
  function range7(from){ return Array.from({length:7},(_,i)=>addDays(from,i)); }
  function hhmm(t){ return (t||'').slice(0,5); }
  function initials(name){ return (name||'').split(/\s+/).map(s=>s[0]).join('').slice(0,2).toUpperCase(); }
  function parseHours(span){
    if(!span||/off/i.test(span)) return 0;
    const m=span.match(/(\d{1,2}):(\d{2})-(\d{1,2}):(\d{2})/);
    if(!m) return 0;
    const s=+m[1]*60+ +m[2]; let e=+m[3]*60+ +m[4]; let diff=e-s; if(diff<0) diff+=1440; return diff/60;
  }

  function makeEmpCell(name, role){
    return `<div class="emp"><div class="avatar">${initials(name)}</div><div><div class="name">${name}</div><small>${role||''}</small></div></div>`;
  }

  // ==== Estado ====
  let employees = [];      // [{id,name,role,department,is_active}]
  let shifts = [];         // [{id, employee_id, date, start_time, end_time, off, break_minutes}]
  let weekStart = startOfWeek(new Date());
  weekStartInp.value = toISO(weekStart);
  const edits = new Map(); // `${empId}-${idx}` -> "OFF" | "HH:MM-HH:MM"

  // ==== Fetch a Supabase ====
  async function getEmployees(){
    const { data, error } = await supabase
      .from('employees')
      .select('*')
      .eq('is_active', true)
      .order('name', { ascending: true });
    if (error) throw error;
    return data;
  }

  async function getShifts(fromISO, toISO){
    const { data, error } = await supabase
      .from('shifts')
      .select('*')
      .gte('date', fromISO)
      .lte('date', toISO);
    if (error) throw error;
    return data;
  }

  async function saveShiftsBulk(items){
    // RPC definida en la DB: upsert_shifts_bulk(payload jsonb)
    const { data, error } = await supabase.rpc('upsert_shifts_bulk', {
      payload: { items }
    });
    if (error) throw error;
    return data;
  }

  // ==== Render semanal ====
  function renderWeek(){
    tbody.innerHTML = '';
    const days = range7(weekStart);
    const dayKeys = days.map(d=> toISO(d));

    for (const emp of employees){
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${makeEmpCell(emp.name, emp.role)}</td>`;
      let tot = 0;

      dayKeys.forEach((k, idx)=>{
        const dayShifts = shifts.filter(s => String(s.employee_id)===String(emp.id) && String(s.date)===k);
        let cell = '';
        if (dayShifts.length){
          let sum = 0;
          cell = dayShifts.map(s=>{
            if (s.off || !s.start_time || !s.end_time) return 'OFF';
            const line = `${hhmm(s.start_time)}-${hhmm(s.end_time)}${s.break_minutes?` (‚àí${s.break_minutes}‚Ä≤)`:''}`;
            // calcular horas
            const h = parseHours(`${hhmm(s.start_time)}-${hhmm(s.end_time)}`);
            sum += h;
            return line;
          }).join('<br>');
          tot += sum;
        } else {
          cell = 'OFF';
        }

        const td = document.createElement('td');
        td.dataset.empId = emp.id;
        td.dataset.dayIdx = idx;
        td.setAttribute('data-day-idx', idx);
        td.innerHTML = cell;
        if (cell==='OFF') td.classList.add('off');

        if (managerMode.checked) td.contentEditable = 'true';
        td.addEventListener('dblclick', ()=>{
          const cur = td.textContent.trim();
          const v = /off/i.test(cur) ? '09:00-18:00' : 'OFF';
          td.textContent = v;
          td.classList.toggle('off', /off/i.test(v));
          markEdited(td);
        });
        td.addEventListener('input', ()=> markEdited(td));

        tr.appendChild(td);
      });

      const tdTot = document.createElement('td');
      tdTot.className = 'right';
      // re-calcula leyendo las celdas editadas (despu√©s)
      tdTot.textContent = Math.round(tot).toString();
      tr.appendChild(tdTot);
      tbody.appendChild(tr);
    }

    // Recalcular totales tras permitir edici√≥n
    [...tbody.querySelectorAll('tr')].forEach(recalcRow);
  }

  function markEdited(td){
    if(!managerMode.checked) return;
    const empId = td.dataset.empId;
    const idx = td.dataset.dayIdx;
    const val = td.textContent.trim();
    edits.set(`${empId}-${idx}`, val);
    td.classList.add('edited'); saveBtn.disabled = false;
    recalcRow(td.closest('tr'));
  }

  function recalcRow(tr){
    const dayTds=[...tr.querySelectorAll('td[data-day-idx]')];
    let tot = 0;
    dayTds.forEach(td => { tot += parseHours(td.textContent.trim()); });
    tr.querySelector('.right').textContent = Math.round(tot).toString();
  }

  // ==== Colleghi di turno (Banco/Laboratorio) ====
  function renderMates(){
    const idx = Number(matesDaySel.value)||0;
    const dayISO = toISO(addDays(weekStart, idx));
    const today = shifts.filter(s => String(s.date)===dayISO);
    const banco = [], lab = [];

    for (const s of today){
      const emp = employees.find(e => String(e.id)===String(s.employee_id));
      if (!emp) continue;
      if (s.off) continue;
      const line = `<span class="tag"><strong>${emp.name}</strong> ${hhmm(s.start_time)}-${hhmm(s.end_time)}</span>`;
      // Regla pedida: Kevin y Lukshan ‚Üí laboratorio, resto banco, o usa department si viene
      const dep = (emp.department||'').toLowerCase();
      const forceLab = /^kevin\b/i.test(emp.name) || /^lukshan\b/i.test(emp.name);
      if (forceLab || dep==='laboratorio' || /lab/i.test(emp.role||'')) lab.push(line); else banco.push(line);
    }

    matesBanco.innerHTML = banco.length ? banco.join(' ') : '‚Äî nessun turno ‚Äî';
    matesLab.innerHTML   = lab.length   ? lab.join(' ')   : '‚Äî nessun turno ‚Äî';
  }

  // ==== Guardar cambios (bulk) ====
  async function saveChanges(){
    if (edits.size===0) return;
    const payload = [];
    edits.forEach((val,key)=>{
      const [empId, idx] = key.split('-');
      const date = toISO(addDays(weekStart, Number(idx)));
      if (/off/i.test(val) || val==='') {
        payload.push({ employee_id: Number(empId), date, off: true });
      } else {
        const m = val.match(/(\d{1,2}):(\d{2})-(\d{1,2}):(\d{2})/);
        if (!m) return;
        payload.push({
          employee_id: Number(empId),
          date,
          start_time: `${m[1]}:${m[2]}`,
          end_time: `${m[3]}:${m[4]}`
        });
      }
    });

    try{
      await saveShiftsBulk(payload);
      edits.clear();
      saveBtn.disabled = true;

      // refrescar semana
      const fromISO = toISO(weekStart);
      const toISOstr = toISO(addDays(weekStart, 6));
      shifts = await getShifts(fromISO, toISOstr);
      renderWeek();
      renderMates();
      alert('Modifiche salvate!');
    }catch(err){
      console.error(err);
      alert('Errore nel salvataggio: ' + (err.message || err));
    }
  }

  // ==== Eventos ====
  document.getElementById('prevW').addEventListener('click', async ()=>{
    weekStart = addDays(weekStart, -7); weekStartInp.value = toISO(weekStart);
    await reloadWeek();
  });
  document.getElementById('thisW').addEventListener('click', async ()=>{
    weekStart = startOfWeek(new Date()); weekStartInp.value = toISO(weekStart);
    await reloadWeek();
  });
  document.getElementById('nextW').addEventListener('click', async ()=>{
    weekStart = addDays(weekStart, 7); weekStartInp.value = toISO(weekStart);
    await reloadWeek();
  });
  weekStartInp.addEventListener('change', async ()=>{
    weekStart = startOfWeek(new Date(weekStartInp.value));
    await reloadWeek();
  });
  managerMode.addEventListener('change', ()=> renderWeek());
  saveBtn.addEventListener('click', saveChanges);
  matesDaySel.addEventListener('change', renderMates);

  // ==== Carga inicial ====
  async function reloadWeek(){
    const fromISO = toISO(weekStart);
    const toISOstr = toISO(addDays(weekStart, 6));
    shifts = await getShifts(fromISO, toISOstr);
    renderWeek();
    renderMates();
  }

  (async function init(){
    try{
      employees = await getEmployees();
      await reloadWeek();
    }catch(err){
      console.error(err);
      alert('Errore caricando dati da Supabase: ' + (err.message || err));
    }
  })();
</script>
</body>
</html>
