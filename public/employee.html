<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>CREMA ‚Ä¢ Turni settimanali (manager)</title>

  <style>
    :root{
      --bg: #f1e4b2;
      --card: #ffffff;
      --ink: #121826;
      --muted:#667085;
      --primary:#ee7523;
      --primary-600:#ee7523;
      --navy:#6a3f24;
      --off:#f8fafc;
      --accent:#fdecc8;
      --border:#e5e7eb;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: system-ui, -apple-system, "Segoe UI", Roboto, Ubuntu, Cantarell, "Noto Sans", "Helvetica Neue", Arial;
      color:var(--ink);
      background: var(--bg);
    }
    .wrap{max-width:1180px;margin:32px auto;padding:0 16px}
    .card{
      background:var(--card);
      border-radius:28px;
      box-shadow: 0 10px 30px rgba(2,6,23,.08);
      padding:24px 20px 28px;
      position:relative;
      overflow:hidden;
    }
    h1{margin:8px 0 4px; font-size: clamp(22px, 3.2vw, 36px);}
    .subtitle{color:var(--muted); font-size:14px; max-width:70ch}

    .toolbar{display:flex;gap:12px;align-items:center;flex-wrap:wrap;margin:14px 0 6px}
    .btn{background:#111827;color:#fff;border:0;border-radius:999px;padding:10px 14px;font-weight:600;cursor:pointer}
    .btn.secondary{background:var(--primary)}
    .switch{display:inline-flex;align-items:center;gap:8px}
    .hint{color:var(--muted);font-size:12px;margin-left:auto}

    .table-wrap{margin-top:18px; border-radius:16px; overflow:auto; border:1px solid var(--border)}
    table{border-collapse:separate; border-spacing:0; width:100%; min-width:980px}
    thead th{position:sticky; top:0; z-index:2; background:var(--primary-600); color:white; font-weight:600; font-size:14px; padding:14px 12px; text-align:left}
    thead th:first-child{background:var(--navy)}
    tbody td{background:#fff; padding:14px 12px; border-bottom:1px solid var(--border); font-size:15px}
    tbody tr:last-child td{border-bottom:none}
    tbody td.off{background:var(--accent)}
    .right{text-align:right}

    .emp{display:flex; align-items:center; gap:12px}
    .avatar{--s:34px; width:var(--s); height:var(--s); border-radius:999px; background:linear-gradient(135deg,#ffd3a8,#ee7523); display:grid; place-items:center; font-weight:700; color:#0b1324}
    .emp .name{font-weight:700}
    .emp small{display:block; color:var(--muted); font-size:12px; margin-top:2px}

    td[contenteditable="true"]{outline:none}
    td.edited{box-shadow:inset 0 0 0 2px #f59e0b;border-radius:6px}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>Programmazione turni settimanale</h1>
      <p class="subtitle">Il manager pu√≤ modificare giorno/ora o impostare <b>OFF</b>. La colonna finale mostra il <b>totale ore</b> settimanali. Sotto vedi i colleghi di turno per un giorno.</p>

      <div class="toolbar">
        <label class="switch"><input type="checkbox" id="managerMode"> Modalit√† manager</label>
        <input type="date" id="weekStart"/>
        <button class="btn" id="prevW">‚óÄ Settimana prec.</button>
        <button class="btn secondary" id="thisW">Questa settimana</button>
        <button class="btn" id="nextW">Settimana succ. ‚ñ∂</button>
        <button class="btn" id="saveBtn" disabled>üíæ Salva modifiche</button>
        <span class="hint">Formato celle: <b>HH:MM-HH:MM</b> o <b>OFF</b>. Doppio clic per alternare OFF.</span>
      </div>

      <div class="table-wrap">
        <table id="schedule">
          <thead>
            <tr>
              <th style="min-width:220px">Dipendente</th>
              <th>Lun</th><th>Mar</th><th>Mer</th><th>Gio</th><th>Ven</th><th>Sab</th><th>Dom</th>
              <th class="right">Totale ore</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>

      <div class="card" style="margin-top:20px">
        <h3>Colleghi di turno</h3>
        <div style="display:flex;gap:12px;align-items:center;margin-bottom:8px">
          <label for="matesDay">Giorno:</label>
          <select id="matesDay">
            <option value="0">Luned√¨</option>
            <option value="1">Marted√¨</option>
            <option value="2">Mercoled√¨</option>
            <option value="3">Gioved√¨</option>
            <option value="4">Venerd√¨</option>
            <option value="5">Sabato</option>
            <option value="6">Domenica</option>
          </select>
        </div>
        <div><strong>Banco</strong>: <span id="mates-banco">‚Äî</span></div>
        <div><strong>Laboratorio</strong>: <span id="mates-lab">‚Äî</span></div>
      </div>
    </div>
  </div>

<script>
  // ===== SEED (sostituire con dati da DB) =====
  const seedRows = [
    { id:1, name:"Steven A.", role:"Banco",       days:["OFF","15:15-23:45","15:15-23:45","15:15-23:45","15:15-23:45","11:00-19:30","11:00-19:30"] },
    { id:2, name:"Angela G.", role:"Banco",       days:["15:15-23:45","15:15-23:45","15:15-23:45","OFF","15:15-23:45","15:15-23:45","15:15-23:45"] },
    { id:3, name:"Kevin L.",  role:"Laboratorio", days:["08:30-15:30","08:30-15:30","OFF","08:30-15:30","08:30-15:30","08:30-15:30","08:30-15:30"] },
    { id:4, name:"Lukshan P.",role:"Laboratorio", days:["16:15-23:45","OFF","10:30-17:30","16:15-23:45","16:15-23:45","16:15-23:45","16:15-23:45"] }
  ];

  // Sugerido para el backend: endpoint bulk upsert
  const API = { shifts:'/api/shifts/bulk' };
  function authHeader(){ const t=localStorage.getItem('token'); return t?{Authorization:'Bearer '+t}:{ }; }

  const tbody = document.querySelector('#schedule tbody');
  const managerMode = document.getElementById('managerMode');
  const saveBtn = document.getElementById('saveBtn');
  const weekStartInp = document.getElementById('weekStart');
  const matesDaySel = document.getElementById('matesDay');

  function toISO(d){ return d.toISOString().slice(0,10); }
  function addDays(d,n){ const x=new Date(d); x.setDate(x.getDate()+n); return x; }
  function startOfWeek(d){ const x=new Date(d); const w=(x.getDay()+6)%7; x.setDate(x.getDate()-w); x.setHours(0,0,0,0); return x; }
  function range7(from){ return Array.from({length:7},(_,i)=>addDays(from,i)); }
  function parseHours(span){
    if(!span||/off/i.test(span)) return 0;
    const m=span.match(/(\d{1,2}):(\d{2})-(\d{1,2}):(\d{2})/);
    if(!m) return 0;
    const s=+m[1]*60+ +m[2]; let e=+m[3]*60+ +m[4];
    let diff=e-s; if(diff<0) diff+=1440;
    return diff/60;
  }
  function initials(name){ return (name||'').split(/\s+/).map(s=>s[0]).join('').slice(0,2).toUpperCase(); }

  let weekStart = startOfWeek(new Date());
  weekStartInp.value = toISO(weekStart);

  const edits = new Map(); // `${empId}-${idx}` -> "OFF" | "HH:MM-HH:MM"

  function makeEmpCell(name, role){
    return `<div class="emp"><div class="avatar">${initials(name)}</div><div><div class="name">${name}</div><small>${role||''}</small></div></div>`;
  }

  function render(){
    tbody.innerHTML='';
    seedRows.forEach(emp=>{
      let tot=0; const tr=document.createElement('tr');
      tr.innerHTML = `<td>${makeEmpCell(emp.name,emp.role)}</td>`;

      emp.days.forEach((orig,idx)=>{
        const key=`${emp.id}-${idx}`; const value=edits.has(key)?edits.get(key):orig;
        const td=document.createElement('td');
        td.dataset.empId=emp.id; td.dataset.dayIdx=idx; td.setAttribute('data-day-idx',idx);
        td.textContent=value;
        if(/off/i.test(value)) td.classList.add('off');
        if(managerMode.checked){ td.contentEditable='true'; } else { td.removeAttribute('contenteditable'); td.classList.remove('edited'); }
        td.addEventListener('dblclick',()=>{
          const current = td.textContent.trim();
          const v = /off/i.test(current) ? '09:00-18:00' : 'OFF';
          td.textContent=v; td.classList.toggle('off',/off/i.test(v)); markEdited(td);
        });
        td.addEventListener('input',()=> markEdited(td));
        tr.appendChild(td);
        tot += parseHours(value);
      });

      const tdTot=document.createElement('td');
      tdTot.className='right';
      tdTot.textContent = Math.round(tot).toString();
      tr.appendChild(tdTot);
      tbody.appendChild(tr);
    });
  }

  function markEdited(td){
    if(!managerMode.checked) return;
    const empId=td.dataset.empId; const idx=td.dataset.dayIdx; const val=td.textContent.trim();
    edits.set(`${empId}-${idx}`, val);
    td.classList.add('edited'); saveBtn.disabled=false; recalcRow(td.closest('tr'));
  }

  function recalcRow(tr){
    const dayTds=[...tr.querySelectorAll('td[data-day-idx]')];
    let tot=0; dayTds.forEach(td=>{ tot+=parseHours(td.textContent.trim());});
    tr.querySelector('.right').textContent=Math.round(tot).toString();
  }

  async function saveChanges(){
    if(edits.size===0) return;
    const payload=[];
    edits.forEach((val,key)=>{
      const [empId,idx]=key.split('-');
      const date = toISO(addDays(weekStart, Number(idx)));
      if(/off/i.test(val)||val===''){ payload.push({ employee_id:Number(empId), date, off:true }); }
      else{
        const m=val.match(/(\d{1,2}):(\d{2})-(\d{1,2}):(\d{2})/);
        if(!m) return;
        payload.push({ employee_id:Number(empId), date, start_time:`${m[1]}:${m[2]}`, end_time:`${m[3]}:${m[4]}` });
      }
    });

    try{
      // Implementare sul backend: POST /api/shifts/bulk  -> {items:[...], week_start:"YYYY-MM-DD"}
      const res = await fetch(API.shifts, {
        method:'POST',
        headers:{'Content-Type':'application/json', ...authHeader()},
        body: JSON.stringify({ items: payload, week_start: toISO(weekStart) })
      });
      if(!res.ok){ console.warn('Save error', await res.text()); alert('Errore nel salvataggio.'); return; }
      edits.clear(); saveBtn.disabled=true; alert('Modifiche salvate!');
    }catch(err){ console.error(err); alert('Errore di rete durante il salvataggio.'); }
  }

  function renderMates(){
    const idx = Number(matesDaySel.value)||0;
    const banco=[]; const lab=[];
    seedRows.forEach(r=>{
      const turno=(edits.get(`${r.id}-${idx}`) ?? r.days[idx])||'';
      if(!/off/i.test(turno)&&turno){
        const line = `${r.name} ${turno}`;
        if(/laboratorio/i.test(r.role) || /^kevin\b/i.test(r.name) || /^lukshan\b/i.test(r.name)) lab.push(line);
        else banco.push(line);
      }
    });
    document.getElementById('mates-banco').textContent=banco.join(', ')||'‚Äî nessun turno ‚Äî';
    document.getElementById('mates-lab').textContent=lab.join(', ')||'‚Äî nessun turno ‚Äî';
  }

  document.getElementById('prevW').addEventListener('click',()=>{ weekStart = addDays(weekStart,-7); weekStartInp.value=toISO(weekStart); render(); renderMates(); });
  document.getElementById('thisW').addEventListener('click',()=>{ weekStart = startOfWeek(new Date()); weekStartInp.value=toISO(weekStart); render(); renderMates(); });
  document.getElementById('nextW').addEventListener('click',()=>{ weekStart = addDays(weekStart, 7); weekStartInp.value=toISO(weekStart); render(); renderMates(); });
  weekStartInp.addEventListener('change',()=>{ weekStart = startOfWeek(new Date(weekStartInp.value)); render(); renderMates(); });
  managerMode.addEventListener('change',()=>{ render(); });
  document.getElementById('saveBtn').addEventListener('click', saveChanges);
  matesDaySel.addEventListener('change', renderMates);

  render();
  renderMates();
</script>
</body>
</html>
