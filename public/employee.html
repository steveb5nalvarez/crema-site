<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>CREMA â€“ Turni settimanali (manager)</title>

  <link rel="stylesheet" href="/styles.css"/>
  <link rel="icon" type="image/svg+xml" href="https://gelatocrema.com/cdn/shop/files/logo_color.svg?v=1693061670&width=100">
  <link rel="alternate icon" href="/favicon.ico">

  <style>
    :root{
      --bg:#f1e4b2; --card:#ffffff; --ink:#121826; --muted:#667085;
      --primary:#ee7523; --primary-600:#ee7523; --navy:#6a3f24;
      --off:#f8fafc; --accent:#fdecc8; --border:#e5e7eb;
    }
    body.admin { background: var(--background-1, #fffce3); }
    *{box-sizing:border-box}

    .wrap{max-width:1180px;margin:24px auto;padding:0 16px}
    .card{background:var(--card);border-radius:28px;box-shadow:0 10px 30px rgba(2,6,23,.08);padding:24px 20px 28px}
    h1{margin:8px 0 4px;font-size:clamp(22px,3.2vw,36px)}
    .subtitle{color:var(--muted);font-size:14px;max-width:70ch}

    .toolbar{display:flex;gap:12px;align-items:center;flex-wrap:wrap;margin:14px 0 10px}
    .btn{background:#111827;color:#fff;border:0;border-radius:999px;padding:10px 14px;font-weight:600;cursor:pointer}
    .btn.secondary{background:var(--primary)}
    .btn[disabled]{opacity:.6;cursor:not-allowed}
    .switch{display:inline-flex;align-items:center;gap:8px}
    .hint{color:var(--muted);font-size:12px;margin-left:auto}

    .table-wrap{margin-top:18px;border-radius:16px;overflow:auto;border:1px solid var(--border)}
    table{border-collapse:separate;border-spacing:0;width:100%;min-width:980px}
    thead th{position:sticky;top:0;z-index:2;background:var(--primary-600);color:white;font-weight:600;font-size:14px;padding:14px 12px;text-align:left}
    thead th:first-child{background:var(--navy)}
    tbody td{background:#fff;padding:14px 12px;border-bottom:1px solid var(--border);font-size:15px}
    tbody tr:last-child td{border-bottom:none}
    tbody td.off{background:var(--accent)}
    .right{text-align:right}

    .emp{display:flex;align-items:center;gap:12px}
    .avatar{--s:34px;width:var(--s);height:var(--s);border-radius:999px;background:linear-gradient(135deg,#ffd3a8,#ee7523);display:grid;place-items:center;font-weight:700;color:#0b1324}
    .emp .name{font-weight:700}
    .emp small{display:block;color:var(--muted);font-size:12px;margin-top:2px}

    td[contenteditable="true"]{outline:none}
    td.edited{box-shadow:inset 0 0 0 2px #f59e0b;border-radius:6px}
    .tag{display:inline-block;padding:.25rem .5rem;border-radius:999px;border:1px solid var(--border);font-size:12px;color:#111827;margin:2px}

    /* Skeleton */
    .sk{display:grid;gap:10px}
    .sk .bar{height:14px;border-radius:999px;background:linear-gradient(90deg,#eee,#f6f6f6,#eee);background-size:200% 100%;animation:s 1.1s linear infinite}
    @keyframes s{0%{background-position:200% 0}100%{background-position:-200% 0}}

    /* status row */
    .status{display:flex;gap:10px;align-items:center;color:#667085;font-size:13px;margin-top:8px}
    .status .dot{width:8px;height:8px;border-radius:999px;background:#10b981}
    .status.error .dot{background:#ef4444}
  </style>
</head>

<body class="admin">
  <header class="nav">
    <div class="nav-inner container">
      <a href="/" class="brand">
        <img src="https://gelatocrema.com/cdn/shop/files/logo_color.svg?v=1693061670&width=100" alt="CREMA" style="height:40px;width:auto">
      </a>
      <div style="margin-left:auto;display:flex;gap:10px">
        <button class="btn" onclick="location.href='/index.html'">Sito</button>
        <button class="btn" onclick="location.href='/admin.html'">Prodotti</button>
        <button class="btn" onclick="location.href='/employee.html'">Area dipendente</button>
        <button class="btn primary" onclick="logout()">Logout</button>
      </div>
    </div>
  </header>

  <!-- app hidden finchÃ© non validiamo il ruolo -->
  <main class="wrap" id="app" hidden>
    <div class="card">
      <h1>Programmazione turni settimanale</h1>
      <p class="subtitle">Il manager puÃ² modificare giorno/ora o impostare <b>OFF</b>. La colonna finale mostra il <b>totale ore</b> settimanali.</p>

      <div class="toolbar">
        <label class="switch"><input type="checkbox" id="managerMode" checked> ModalitÃ  manager</label>
        <input type="date" id="weekStart"/>
        <button class="btn" id="prevW">â—€ Settimana prec.</button>
        <button class="btn secondary" id="thisW">Questa settimana</button>
        <button class="btn" id="nextW">Settimana succ. â–¶</button>
        <button class="btn" id="saveBtn" disabled>ðŸ’¾ Salva modifiche</button>
        <span class="hint">Formato celle: <b>HH:MM-HH:MM</b> o <b>OFF</b>. Doppio clic per alternare OFF.</span>
      </div>

      <div class="table-wrap">
        <table id="schedule" aria-live="polite">
          <thead>
            <tr>
              <th style="min-width:220px">Dipendente</th>
              <th>Lun</th><th>Mar</th><th>Mer</th><th>Gio</th><th>Ven</th><th>Sab</th><th>Dom</th>
              <th class="right">Totale ore</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
        <div id="skel" class="sk" style="padding:14px 12px;display:none">
          <div class="bar" style="width:70%"></div>
          <div class="bar" style="width:55%"></div>
          <div class="bar" style="width:62%"></div>
        </div>
      </div>

      <div class="status" id="status"><span class="dot"></span><span id="statusText">Pronto</span></div>

      <div class="card" style="margin-top:20px">
        <h3>Colleghi di turno</h3>
        <div style="display:flex;gap:12px;align-items:center;margin-bottom:8px">
          <label for="matesDay">Giorno:</label>
          <select id="matesDay">
            <option value="0">LunedÃ¬</option><option value="1">MartedÃ¬</option><option value="2">MercoledÃ¬</option>
            <option value="3">GiovedÃ¬</option><option value="4">VenerdÃ¬</option><option value="5">Sabato</option><option value="6">Domenica</option>
          </select>
        </div>
        <div><strong>Banco</strong>: <span id="mates-banco">â€”</span></div>
        <div><strong>Laboratorio</strong>: <span id="mates-lab">â€”</span></div>
      </div>
    </div>
  </main>

  <script type="module">
    import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm";

    // === Supabase ===
    const SUPABASE_URL = "https://tcfmeggqhxcnihkmnkqs.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRjZm1lZ2dxaHhjbmloa21ua3FzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTcxOTAzMjUsImV4cCI6MjA3Mjc2NjMyNX0.VYkrvIVWti57W9UOnQcCvywmonWGyrtIT4KAzszbiFs";
    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // logout del header
    window.logout = async () => { await supabase.auth.signOut(); location.href = "/login.html"; };

    // Guard: solo manager
    async function ensureManager(){
      const { data:{ user } } = await supabase.auth.getUser();
      if(!user){ location.href="/login.html"; return false; }
      const { data: prof, error } = await supabase.from('profiles').select('role, full_name').eq('user_id', user.id).single();
      if(error || !prof){ location.href="/login.html"; return false; }
      if(prof.role !== 'manager'){ location.href="/employee.html"; return false; }
      // hint en brand
      const brand = document.querySelector('.brand'); if(brand && prof.full_name) brand.title = `Manager: ${prof.full_name}`;
      return true;
    }

    // DOM refs
    const app = document.getElementById('app');
    const tbody = document.querySelector('#schedule tbody');
    const skel  = document.getElementById('skel');
    const statusRow = document.getElementById('status');
    const statusText = document.getElementById('statusText');

    const managerMode = document.getElementById('managerMode');
    const saveBtn = document.getElementById('saveBtn');
    const weekStartInp = document.getElementById('weekStart');
    const matesDaySel = document.getElementById('matesDay');
    const matesBanco = document.getElementById('mates-banco');
    const matesLab = document.getElementById('mates-lab');

    // Utils
    const toISO = d => d.toISOString().slice(0,10);
    const addDays = (d,n)=>{const x=new Date(d); x.setDate(x.getDate()+n); return x;};
    const startOfWeek = d => {const x=new Date(d); const w=(x.getDay()+6)%7; x.setDate(x.getDate()-w); x.setHours(0,0,0,0); return x;};
    const range7 = from => Array.from({length:7},(_,i)=>addDays(from,i));
    const hhmm = t => (t||'').slice(0,5);
    const parseHours = (span)=>{
      if(!span || /off/i.test(span)) return 0;
      const m=span.match(/(\d{1,2}):(\d{2})-(\d{1,2}):(\d{2})/);
      if(!m) return 0;
      const s=+m[1]*60+ +m[2]; let e=+m[3]*60+ +m[4]; let diff=e-s; if(diff<0) diff+=1440; return diff/60;
    };
    const initials = name => (name||'').split(/\s+/).map(s=>s[0]).join('').slice(0,2).toUpperCase();
    const empCell = (name,role)=>`<div class="emp"><div class="avatar">${initials(name)}</div><div><div class="name">${name}</div><small>${role||''}</small></div></div>`;

    // Estado
    let employees = [];
    let shifts = [];
    let weekStart = startOfWeek(new Date());
    weekStartInp.value = toISO(weekStart);
    const edits = new Map(); // `${empId}-${idx}` -> "OFF" | "HH:MM-HH:MM"
    let rpcAvailable = true;

    // API (Supabase)
    async function getEmployees(){
      const { data, error } = await supabase.from('employees').select('*').eq('is_active', true).order('name',{ascending:true});
      if (error) throw error; return data || [];
    }
    async function getShifts(fromISO, toISOstr){
      const { data, error } = await supabase.from('shifts').select('*').gte('date', fromISO).lte('date', toISOstr);
      if (error) throw error; return data || [];
    }
    async function saveShiftsBulk(items){
      const { data, error } = await supabase.rpc('upsert_shifts_bulk', { payload: { items } });
      if (error) throw error; return data;
    }

    // Render settimana
    function renderWeek(){
      tbody.innerHTML = '';
      const dayKeys = range7(weekStart).map(d=>toISO(d));

      for (const emp of employees){
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${empCell(emp.name, emp.role)}</td>`;
        let tot = 0;

        dayKeys.forEach((k, idx)=>{
          const dayShifts = shifts.filter(s => String(s.employee_id)===String(emp.id) && String(s.date)===k);
          let cell = 'OFF', sum=0;
          if (dayShifts.length){
            cell = dayShifts.map(s=>{
              if (s.off || !s.start_time || !s.end_time) return 'OFF';
              const line = `${hhmm(s.start_time)}-${hhmm(s.end_time)}`;
              sum += parseHours(line);
              return line;
            }).join('<br>');
          }
          tot += sum;

          const td = document.createElement('td');
          td.dataset.empId = emp.id;
          td.dataset.dayIdx = idx;
          td.setAttribute('data-day-idx', idx);
          td.innerHTML = cell;
          if (cell==='OFF') td.classList.add('off');

          td.contentEditable = managerMode.checked ? 'true' : 'false';
          td.addEventListener('dblclick', ()=>{
            if(!managerMode.checked) return;
            const cur = td.textContent.trim();
            const v = /off/i.test(cur) ? '09:00-18:00' : 'OFF';
            td.textContent = v;
            td.classList.toggle('off', /off/i.test(v));
            markEdited(td);
          });
          td.addEventListener('input', ()=> managerMode.checked && markEdited(td));

          tr.appendChild(td);
        });

        const tdTot = document.createElement('td');
        tdTot.className = 'right';
        tdTot.textContent = Math.round(tot).toString();
        tr.appendChild(tdTot);
        tbody.appendChild(tr);
      }
      [...tbody.querySelectorAll('tr')].forEach(recalcRow);
    }

    function markEdited(td){
      const empId = td.dataset.empId;
      const idx = td.dataset.dayIdx;
      const val = td.textContent.trim();
      edits.set(`${empId}-${idx}`, val);
      td.classList.add('edited'); saveBtn.disabled = false;
      recalcRow(td.closest('tr'));
    }

    function recalcRow(tr){
      const dayTds = [...tr.querySelectorAll('td[data-day-idx]')];
      let tot = 0;
      dayTds.forEach(td => { tot += parseHours(td.textContent.trim()); });
      tr.querySelector('.right').textContent = Math.round(tot).toString();
    }

    // Colleghi oggi
    function renderMates(){
      const idx = Number(matesDaySel.value)||0;
      const dayISO = toISO(addDays(weekStart, idx));
      const today = shifts.filter(s => String(s.date)===dayISO);
      const banco = [], lab = [];

      for (const s of today){
        const emp = employees.find(e => String(e.id)===String(s.employee_id));
        if (!emp || s.off) continue;
        const line = `<span class="tag"><strong>${emp.name}</strong> ${hhmm(s.start_time)}-${hhmm(s.end_time)}</span>`;
        const dep = (emp.department||'').toLowerCase();
        const forceLab = /^kevin\b/i.test(emp.name) || /^lukshan\b/i.test(emp.name);
        if (forceLab || dep==='laboratorio' || /lab/i.test(emp.role||'')) lab.push(line); else banco.push(line);
      }

      matesBanco.innerHTML = banco.length ? banco.join(' ') : 'â€” nessun turno â€”';
      matesLab.innerHTML   = lab.length   ? lab.join(' ')   : 'â€” nessun turno â€”';
    }

    // Salvar cambios
    async function saveChanges(){
      if (edits.size===0) return;
      if (!rpcAvailable){ alert("Funzione bulk non disponibile. Contatta l'amministratore."); return; }

      const payload = [];
      edits.forEach((val,key)=>{
        const [empId, idx] = key.split('-');
        const date = toISO(addDays(weekStart, Number(idx)));
        if (/off/i.test(val) || val==='') {
          payload.push({ employee_id: Number(empId), date, off: true });
        } else {
          const m = val.match(/(\d{1,2}):(\d{2})-(\d{1,2}):(\d{2})/);
          if (!m) return;
          payload.push({ employee_id:Number(empId), date, start_time:`${m[1]}:${m[2]}`, end_time:`${m[3]}:${m[4]}` });
        }
      });

      try{
        saveBtn.disabled = true; saveBtn.textContent = 'Salvataggioâ€¦';
        statusRow.classList.remove('error'); statusText.textContent = 'Salvataggio in corsoâ€¦';
        await saveShiftsBulk(payload);
        edits.clear();
        const fromISO = toISO(weekStart);
        const toISOstr = toISO(addDays(weekStart, 6));
        shifts = await getShifts(fromISO, toISOstr);
        renderWeek(); renderMates();
        statusText.textContent = 'Modifiche salvate';
      }catch(err){
        console.error(err);
        statusRow.classList.add('error');
        statusText.textContent = 'Errore salvataggio';
        alert('Errore nel salvataggio: ' + (err.message || err));
      }finally{
        saveBtn.textContent = 'ðŸ’¾ Salva modifiche';
        saveBtn.disabled = edits.size===0;
      }
    }

    // Eventi
    document.getElementById('prevW').addEventListener('click', async ()=>{
      weekStart = addDays(weekStart, -7); weekStartInp.value = toISO(weekStart);
      await reloadWeek();
    });
    document.getElementById('thisW').addEventListener('click', async ()=>{
      weekStart = startOfWeek(new Date()); weekStartInp.value = toISO(weekStart);
      await reloadWeek();
    });
    document.getElementById('nextW').addEventListener('click', async ()=>{
      weekStart = addDays(weekStart, 7); weekStartInp.value = toISO(weekStart);
      await reloadWeek();
    });
    weekStartInp.addEventListener('change', async ()=>{
      weekStart = startOfWeek(new Date(weekStartInp.value));
      await reloadWeek();
    });
    managerMode.addEventListener('change', ()=>{
      // rehace contentEditable de las celdas
      [...tbody.querySelectorAll('td[data-day-idx]')].forEach(td=>{
        td.contentEditable = managerMode.checked ? 'true' : 'false';
      });
    });
    saveBtn.addEventListener('click', saveChanges);
    matesDaySel.addEventListener('change', renderMates);

    async function reloadWeek(){
      try{
        skel.style.display = 'block';
        const fromISO = toISO(weekStart);
        const toISOstr = toISO(addDays(weekStart, 6));
        shifts = await getShifts(fromISO, toISOstr);
        renderWeek(); renderMates();
      } finally {
        skel.style.display = 'none';
      }
    }

    // Init
    (async function init(){
      const ok = await ensureManager();
      if(!ok) return;

      app.hidden = false;
      skel.style.display = 'block';

      // probar disponibilidad de RPC
      try {
        await supabase.rpc('upsert_shifts_bulk', { payload: { items: [] } });
        rpcAvailable = true;
      } catch {
        rpcAvailable = false;
        saveBtn.style.display = 'none';
        statusRow.classList.add('error');
        statusText.textContent = 'Funzione bulk non disponibile';
      }

      try{
        employees = await getEmployees();
        await reloadWeek();
        statusText.textContent = 'Pronto';
      }catch(err){
        console.error(err);
        statusRow.classList.add('error');
        statusText.textContent = 'Errore caricamento';
        alert('Errore caricando dati da Supabase: ' + (err.message || err));
      }finally{
        skel.style.display = 'none';
      }
    })();
  </script>
</body>
</html>