r<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Admin • CREMA</title>
  <link rel="stylesheet" href="/styles.css"/>
</head>
<body>
  <nav class="nav">
    <div class="nav-inner container">
      <a href="/" class="brand">CREMA</a>
      <div style="margin-left:auto;display:flex;gap:8px">
        <button class="btn" onclick="location.href='/admin-shifts.html'">Turni</button>
        <a class="btn" href="/employee.html">Area dipendente</a>
        <button class="btn" onclick="logout()">Logout</button>
      </div>
    </div>
  </nav>

  <main class="container">
    <h2 class="cormorant">Dashboard Admin</h2>

    <section id="login-card" class="card" style="max-width:420px">
      <h3>Accedi</h3>
      <div style="display:grid;gap:8px">
        <label>Username</label>
        <input id="username" placeholder="user">
        <label>Password</label>
        <input id="password" type="password" placeholder="•••••">
        <button class="btn primary" onclick="login()">Entra</button>
      </div>
    </section>

    <section id="app" style="display:none">
      <div class="card" style="margin:16px 0">
        <h3>Crea / Modifica Prodotto</h3>
        <div style="display:grid;gap:8px;grid-template-columns:1fr 1fr">
          <div style="grid-column:span 2">
            <label>Nome</label>
            <input id="p-name">
          </div>
          <div>
            <label>Categoria</label>
            <input id="p-category" placeholder="Gelato, Sorbetto, Granite…">
          </div>
          <div>
            <label>Prezzo (€)</label>
            <input id="p-price" type="number" step="0.01">
          </div>
          <div style="grid-column:span 2">
            <label>Descrizione</label>
            <textarea id="p-description" rows="2"></textarea>
          </div>
          <div style="grid-column:span 2">
            <label>Ingredienti</label>
            <textarea id="p-ingredients" rows="2"></textarea>
          </div>
          <div>
            <label>Foto</label>
            <input id="p-image" type="file" accept="image/*">
          </div>
          <div>
            <label>URL immagine (opzionale)</label>
            <input id="p-image-url" placeholder="URL pubblico">
          </div>
          <div style="grid-column:span 2;display:flex;gap:8px">
            <button class="btn primary" onclick="saveProduct()">Salva</button>
            <button class="btn" onclick="resetForm()">Nuovo</button>
          </div>
        </div>
      </div>

      <div class="card">
        <h3>Prodotti</h3>
        <table class="table" id="table"></table>
      </div>
    </section>
  </main>

<script>
const API_BASE = '/api';
let TOKEN = localStorage.getItem('token') || null;
const loginCard = document.getElementById('login-card');
const app = document.getElementById('app');
const table = document.getElementById('table');

function showApp(){
  if(TOKEN){ loginCard.style.display='none'; app.style.display='block'; loadProducts(); }
  else { loginCard.style.display='block'; app.style.display='none'; }
}
showApp();

async function login(){
  const username = document.getElementById('username').value;
  const password = document.getElementById('password').value;
  const res = await fetch(API_BASE + '/auth/login', {
    method:'POST', headers:{'Content-Type':'application/json'},
    body: JSON.stringify({username, password})
  });
  const data = await res.json();
  if(data.token){
    TOKEN = data.token; localStorage.setItem('token', TOKEN); showApp();
  }else{
    alert(data.error || 'Errore di accesso');
  }
}

function logout(){ TOKEN=null; localStorage.removeItem('token'); showApp(); }

async function uploadImage(file){
  const fd = new FormData(); fd.append('image', file);
  const res = await fetch(API_BASE + '/upload', { method:'POST', headers:{'Authorization':'Bearer '+TOKEN}, body: fd });
  const data = await res.json(); if(data.error){ alert(data.error); throw new Error(data.error); } return data.url;
}

async function saveProduct(){
  let image_url = document.getElementById('p-image-url').value.trim();
  const file = document.getElementById('p-image').files[0];
  if(file){ image_url = await uploadImage(file); }

  const payload = {
    name: document.getElementById('p-name').value,
    category: document.getElementById('p-category').value,
    price: parseFloat(document.getElementById('p-price').value || 0),
    description: document.getElementById('p-description').value,
    ingredients: document.getElementById('p-ingredients').value,
    image_url
  };
  const method = (saveProduct.editingId ? 'PUT' : 'POST');
  const url = API_BASE + '/products' + (saveProduct.editingId ? '/' + saveProduct.editingId : '');
  const res = await fetch(url, {
    method, headers:{'Content-Type':'application/json','Authorization':'Bearer '+TOKEN},
    body: JSON.stringify(payload)
  });
  const data = await res.json();
  if(data.error){ alert(data.error); return; }
  resetForm(); loadProducts();
}

function resetForm(){
  saveProduct.editingId = null;
  ['p-name','p-category','p-price','p-description','p-ingredients','p-image-url','p-image'].forEach(id=>{
    const el = document.getElementById(id);
    if(el.type==='file') el.value = ''; else el.value = '';
  });
}

async function loadProducts(){
  const res = await fetch(API_BASE + '/products');
  const rows = await res.json();
  table.innerHTML = '<tr><th>Foto</th><th>Nome</th><th>Categoria</th><th>Prezzo</th><th>Azioni</th></tr>';
  rows.forEach(p=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td><img src="${p.image_url || ''}" style="width:60px;height:60px;object-fit:cover;border-radius:8px;border:1px solid #eee"/></td>
      <td>${p.name}</td>
      <td>${p.category||''}</td>
      <td>${p.price!=null? Number(p.price).toFixed(2):''}</td>
      <td>
        <button class="btn" onclick='editProduct(${JSON.stringify(p).replace(/'/g,"&#39;")})'>Modifica</button>
        <button class="btn" onclick="del(${p.id})">Elimina</button>
      </td>
    `;
    table.appendChild(tr);
  });
}

function editProduct(p){
  saveProduct.editingId = p.id;
  document.getElementById('p-name').value = p.name || '';
  document.getElementById('p-category').value = p.category || '';
  document.getElementById('p-price').value = p.price || '';
  document.getElementById('p-description').value = p.description || '';
  document.getElementById('p-ingredients').value = p.ingredients || '';
  document.getElementById('p-image-url').value = p.image_url || '';
  window.scrollTo({top:0, behavior:'smooth'});
}

async function del(id){
  if(!confirm('Eliminare questo prodotto?')) return;
  const res = await fetch(API_BASE + '/products/' + id, { method:'DELETE', headers:{'Authorization':'Bearer '+TOKEN}});
  const data = await res.json(); if(data.error){ alert(data.error); } else { loadProducts(); }
}
</script>
</body>
</html>

