<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>CREMA – Admin Prodotti</title>
  <link rel="stylesheet" href="/styles.css"/>
  <link rel="icon" type="image/svg+xml" href="https://gelatocrema.com/cdn/shop/files/logo_color.svg?v=1693061670&width=100">
  <link rel="alternate icon" href="/favicon.ico">
</head>
<body class="admin">
<header class="nav">
  <div class="nav-inner container">
    <a href="/" class="brand">
      <img src="https://gelatocrema.com/cdn/shop/files/logo_color.svg?v=1693061670&width=100" alt="CREMA" style="height:40px;width:auto">
    </a>
    <div style="margin-left:auto;display:flex;gap:10px">
      <button class="btn" onclick="location.href='/index.html'">Sito</button>
      <button class="btn" onclick="location.href='/admin-shifts.html'">Turni</button>
      <button class="btn" onclick="location.href='/employee.html'">Area dipendente</button>
      <button class="btn primary" onclick="logout()">Logout</button>
    </div>
  </div>
</header>

<main class="container admin-main">
  <h1 class="cormorant">Gestione Prodotti</h1>

  <!-- Aggiungi prodotto -->
  <section class="card" style="margin-bottom:1rem">
    <h3>Aggiungi nuovo prodotto</h3>
    <div class="form-row">
      <input id="p-name" placeholder="Nome"/>
      <input id="p-cat" placeholder="Categoria"/>
      <input id="p-img" placeholder="URL immagine"/>
      <textarea id="p-desc" placeholder="Descrizione" style="flex:1"></textarea>
      <textarea id="p-ing" placeholder="Ingredienti" style="flex:1"></textarea>
      <button class="btn primary" onclick="addProduct()">Aggiungi</button>
    </div>
  </section>

  <!-- Lista prodotti -->
  <section id="plist" class="grid"></section>
</main>

<script>
const API = '/api/products';
function authHeader(){
  const t = localStorage.getItem('token');
  return t ? { 'Authorization': 'Bearer ' + t } : {};
}
function logout(){ localStorage.removeItem('token'); location.href='/admin.html'; }

async function addProduct(){
  const payload = {
    name: document.getElementById('p-name').value.trim(),
    category: document.getElementById('p-cat').value.trim(),
    image_url: document.getElementById('p-img').value.trim(),
    description: document.getElementById('p-desc').value.trim(),
    ingredients: document.getElementById('p-ing').value.trim()
  };
  if(!payload.name) return alert('Nome richiesto');
  const res = await fetch(API, {method:'POST', headers:{'Content-Type':'application/json', ...authHeader()}, body: JSON.stringify(payload)});
  const data = await res.json();
  if(data.error) return alert(data.error);
  document.getElementById('p-name').value=''; document.getElementById('p-cat').value=''; document.getElementById('p-img').value='';
  document.getElementById('p-desc').value=''; document.getElementById('p-ing').value='';
  loadProducts();
}

async function loadProducts(){
  const res = await fetch(API, {headers:{...authHeader()}});
  const data = await res.json();
  const list = document.getElementById('plist');
  list.innerHTML = '';
  data.forEach(p=>{
    const div = document.createElement('div');
    div.className = 'card';
    div.innerHTML = `
      <img src="${p.image_url||'https://images.unsplash.com/photo-1551024709-8f23befc6cf7?w=400'}" style="width:100%;height:160px;object-fit:cover;border-radius:8px"/>
      <h3 style="margin:.5rem 0">${p.name}</h3>
      <small class="badge">${p.category||'—'}</small>
      <p style="margin:.5rem 0;color:#555">${p.description||''}</p>
      <p><strong>Ingredienti:</strong> ${p.ingredients||'—'}</p>
      <div class="actions">
        <button class="btn" onclick="editProduct(${p.id})">Modifica</button>
        <button class="btn" onclick="delProduct(${p.id})">Elimina</button>
      </div>
    `;
    list.appendChild(div);
  });
}

async function delProduct(id){
  if(!confirm('Eliminare prodotto?')) return;
  const res = await fetch(API+'/'+id, {method:'DELETE', headers:{...authHeader()}});
  const data = await res.json();
  if(data.error) return alert(data.error);
  loadProducts();
}

function editProduct(id){
  const prod = prompt('Nuovo nome prodotto (lascia vuoto per non modificare):');
  if(prod===null) return;
  const body = { name: prod };
  fetch(API+'/'+id, {method:'PUT', headers:{'Content-Type':'application/json', ...authHeader()}, body: JSON.stringify(body)})
    .then(r=>r.json()).then(()=>loadProducts());
}

function init(){
  const t = localStorage.getItem('token');
  if(!t){ location.href='/index.html'; return; }
  loadProducts();
}
init();
</script>
</body>
</html>