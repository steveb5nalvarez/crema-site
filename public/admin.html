<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Dashboard Turni CREMA</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@unocss/reset/tailwind.css">
  <script src="https://cdn.tailwindcss.com"></script>
  <script type="module">
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm'
    window.supabase = createClient(
      'https://tcfmeggqhxcnihkmnkqs.supabase.co',
      'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRjZm1lZ2dxaHhjbmloa21ua3FzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTcxOTAzMjUsImV4cCI6MjA3Mjc2NjMyNX0.VYkrvIVWti57W9UOnQcCvywmonWGyrtIT4KAzszbiFs'
    )
  </script>
  <style>
    /* Mini fix per layout admin */
    :root{ --muted:#667085; --border:rgba(0,0,0,.12); }
    body.admin { background: var(--background-1, #fffce3); }
    .admin-main .grid { display:grid; grid-template-columns: repeat(auto-fill, minmax(260px, 1fr)); gap: 16px; }
    .card .actions { display:flex; gap:8px; margin-top:10px; }
@@ -23,16 +23,27 @@
    .modal-body form label { display:block; font-weight:600; font-size:.95rem; color:#444; }
    .modal-body form input,
    .modal-body form textarea,
    .modal-body form select { width:100%; padding:10px 12px; border:1px solid rgba(0,0,0,.12); border-radius:8px; }
    .modal-body form select { width:100%; padding:10px 12px; border:1px solid var(--border); border-radius:8px; }
    .modal-body form textarea { resize:vertical; }
    .two-col { display:grid; grid-template-columns:1fr 1fr; gap:12px; }
    @media (max-width: 640px){ .two-col { grid-template-columns:1fr; } }

    /* Empty / skeleton */
    .empty { color:var(--muted); text-align:center; padding:28px 12px; border:1px dashed var(--border); border-radius:12px; }
    .skeleton { background:linear-gradient(90deg,#eee,#f6f6f6,#eee); background-size:200% 100%; animation:s 1.2s infinite; border-radius:10px; }
    @keyframes s { 0%{background-position:200% 0} 100%{background-position:-200% 0} }
    .sk-card { padding:12px; border-radius:12px; background:#fff; box-shadow:0 1px 4px rgba(0,0,0,.06); display:grid; gap:8px; }
    .sk-img { height:160px; }

    /* Inputs */
    #search { max-width:320px; padding:10px 12px; border:1px solid var(--border); border-radius:8px; }
    .btn.primary[disabled], .btn[disabled] { opacity:.65; cursor:not-allowed; }
  </style>
</head>
<body class="admin">
<header class="nav">
  <div class="nav-inner container">
    <a href="/" class="brand">
    <a href="/" class="brand" title="Area Admin">
      <img src="https://gelatocrema.com/cdn/shop/files/logo_color.svg?v=1693061670&width=100" alt="CREMA" style="height:40px;width:auto">
    </a>
    <div style="margin-left:auto;display:flex;gap:10px">
@@ -45,22 +56,24 @@
</header>

<main class="container admin-main" id="app" hidden>
  <div style="display:flex;align-items:center;gap:10px;flex-wrap:wrap;margin-bottom:12px">
  <div style="display:flex;align-items:center;gap:10px;flex-wrap:wrap;margin:12px 0 16px">
    <h1 class="cormorant" style="margin:0">Gestione Prodotti</h1>
    <button class="btn primary" onclick="openProductForm()">+ Nuovo</button>
    <input id="search" placeholder="Cerca per nome o categoria..." style="margin-left:auto;max-width:320px;padding:10px 12px;border:1px solid rgba(0,0,0,.12);border-radius:8px">
    <button class="btn primary" id="btnNew">+ Nuovo</button>
    <input id="search" placeholder="Cerca per nome o categoria..." style="margin-left:auto">
  </div>

  <!-- Lista prodotti -->
  <section id="plist" class="grid"></section>
  <section id="plist" class="grid" aria-live="polite"></section>
  <div id="empty" class="empty" style="display:none">Nessun prodotto. Crea il primo con “+ Nuovo”.</div>
  <div id="err" class="empty" style="display:none; color:#b00020; border-color:#f2b8b5">Si è verificato un errore. Riprova.</div>
</main>

<!-- Modal CREAZIONE / MODIFICA -->
<div id="productModal" class="modal">
<div id="productModal" class="modal" aria-hidden="true">
  <div class="modal-content">
    <div class="modal-header">
      <strong id="pm-title">Nuovo prodotto</strong>
      <button class="btn" onclick="toggleProductModal(false)">Chiudi</button>
      <button class="btn" id="btnClose">Chiudi</button>
    </div>
    <div class="modal-body">
      <form id="productForm">
@@ -103,7 +116,7 @@ <h1 class="cormorant" style="margin:0">Gestione Prodotti</h1>
          </div>
        </div>
        <div style="display:flex;gap:10px;justify-content:flex-end;margin-top:12px">
          <button type="button" class="btn" onclick="toggleProductModal(false)">Annulla</button>
          <button type="button" class="btn" id="btnCancel">Annulla</button>
          <button class="btn primary" id="btnSave" type="submit">Salva</button>
        </div>
      </form>
@@ -124,9 +137,12 @@ <h1 class="cormorant" style="margin:0">Gestione Prodotti</h1>
  async function ensureManager() {
    const { data: { user } } = await supabase.auth.getUser();
    if (!user) { location.href = "/login.html"; return false; }
    const { data: prof, error } = await supabase.from('profiles').select('role').eq('user_id', user.id).single();
    const { data: prof, error } = await supabase.from('profiles').select('role, full_name').eq('user_id', user.id).single();
    if (error || !prof) { location.href = "/login.html"; return false; }
    if (prof.role !== 'manager') { location.href = "/employee.html"; return false; }
    // hint en brand
    const brand = document.querySelector('.brand');
    if (brand && prof.full_name) brand.title = `Manager: ${prof.full_name}`;
    return true;
  }

@@ -136,118 +152,197 @@ <h1 class="cormorant" style="margin:0">Gestione Prodotti</h1>
    location.href = "/login.html";
  };

  // ====== UI helpers ======
  const DEFAULT_IMG = 'https://images.unsplash.com/photo-1551024709-8f23befc6cf7?w=800';
  // ====== UI refs ======
  const DEFAULT_IMG = 'https://images.unsplash.com/photo-1551024709-8f23befc6cf7?w=800&auto=format&fit=crop';
  const app   = document.getElementById('app');
  const qSearch = document.getElementById('search');
  const list = document.getElementById('plist');
  const list  = document.getElementById('plist');
  const empty = document.getElementById('empty');
  const errBox= document.getElementById('err');
  const modal = document.getElementById('productModal');
  const btnNew= document.getElementById('btnNew');
  const btnClose=document.getElementById('btnClose');
  const btnCancel=document.getElementById('btnCancel');
  const form  = document.getElementById('productForm');
  const btnSave = document.getElementById('btnSave');

  const fId   = document.getElementById('p-id');
  const fName = document.getElementById('p-name');
  const fCat  = document.getElementById('p-cat');
  const fDesc = document.getElementById('p-desc');
  const fIng  = document.getElementById('p-ing');
  const fImg  = document.getElementById('p-img');
  const fAvail= document.getElementById('p-available');
  const fTags = document.getElementById('p-tags');
  const fOrder= document.getElementById('p-order');

  function setHidden(el, hidden){ el.style.display = hidden ? 'none' : ''; }
  function toggleProductModal(show){
    document.getElementById('productModal').classList[show?'add':'remove']('open');
    modal.classList[show?'add':'remove']('open');
    modal.setAttribute('aria-hidden', show ? 'false' : 'true');
  }

  function openProductForm(prod){
    document.getElementById('pm-title').textContent = prod ? 'Modifica prodotto' : 'Nuovo prodotto';
    const f = document.getElementById('productForm');
    f.reset();
    document.getElementById('p-id').value = prod?.id || '';
    document.getElementById('p-name').value = prod?.name || '';
    document.getElementById('p-cat').value = prod?.category || '';
    document.getElementById('p-desc').value = prod?.description || '';
    document.getElementById('p-ing').value = prod?.ingredients || '';
    document.getElementById('p-img').value = prod?.image_url || '';
    document.getElementById('p-available').value = String(prod?.is_available ?? true);
    document.getElementById('p-tags').value = Array.isArray(prod?.tags) ? prod.tags.join(', ') : '';
    document.getElementById('p-order').value = prod?.sort_order ?? 0;
    toggleProductModal(true);
  // ====== Skeletons ======
  function showSkeleton(count=6){
    list.innerHTML = '';
    for(let i=0;i<count;i++){
      const wrap = document.createElement('div');
      wrap.className = 'sk-card';
      wrap.innerHTML = `
        <div class="skeleton sk-img"></div>
        <div class="skeleton" style="height:16px; width:60%"></div>
        <div class="skeleton" style="height:12px; width:40%"></div>
        <div class="skeleton" style="height:12px; width:80%"></div>
      `;
      list.appendChild(wrap);
    }
    setHidden(empty, true); setHidden(errBox, true);
  }
  window.openProductForm = openProductForm;

  // ====== Render ======
  function productCard(p){
    const div = document.createElement('div');
    div.className = 'card';
    const safeName = p.name ?? '';
    const safeCat  = p.category || '—';
    const safeDesc = p.description || '';
    const safeIng  = p.ingredients || '';
    div.innerHTML = `
      <img src="${p.image_url || DEFAULT_IMG}" alt="" style="width:100%;height:160px;object-fit:cover;border-radius:8px"/>
      <h3 style="margin:.5rem 0">${p.name}</h3>
      <h3 style="margin:.5rem 0">${safeName}</h3>
      <div style="display:flex;justify-content:space-between;align-items:center">
        <small class="badge">${p.category || '—'}</small>
        <small class="badge">${safeCat}</small>
        <small>${p.is_available ? 'Disponibile' : 'Non disponibile'}</small>
      </div>
      <p style="margin:.5rem 0;color:#555">${p.description ? p.description : ''}</p>
      ${p.ingredients ? `<p><strong>Ingredienti:</strong> ${p.ingredients}</p>` : ''}
      ${safeDesc ? `<p style="margin:.5rem 0;color:#555">${safeDesc}</p>` : ''}
      ${safeIng ? `<p><strong>Ingredienti:</strong> ${safeIng}</p>` : ''}
      <div class="actions">
        <button class="btn">Modifica</button>
        <button class="btn danger">Elimina</button>
        <button class="btn btn-edit">Modifica</button>
        <button class="btn danger btn-del">Elimina</button>
      </div>
    `;
    // actions
    div.querySelector('.actions .btn').onclick = () => openProductForm(p);
    div.querySelector('.actions .danger').onclick = () => delProduct(p.id);
    div.querySelector('.btn-edit').onclick = () => openProductForm(p);
    div.querySelector('.btn-del').onclick  = () => delProduct(p.id);
    return div;
  }

  // ====== CRUD usando Supabase ======
  // ====== CRUD ======
  async function loadProducts(){
    const { data, error } = await supabase
      .from('products')
      .select('*')
      .order('sort_order', { ascending: true })
      .order('created_at', { ascending: false });
    if (error) { alert(error.message); return; }

    const q = qSearch.value.trim().toLowerCase();
    list.innerHTML = '';
    (data||[])
      .filter(p => !q || (p.name?.toLowerCase().includes(q) || p.category?.toLowerCase().includes(q)))
      .forEach(p => list.appendChild(productCard(p)));
    try{
      showSkeleton(6);
      const { data, error } = await supabase
        .from('products')
        .select('*')
        .order('sort_order', { ascending: true })
        .order('created_at', { ascending: false });
      if (error) throw error;

      const q = qSearch.value.trim().toLowerCase();
      const filtered = (data||[])
        .filter(p => !q || (p.name?.toLowerCase().includes(q) || p.category?.toLowerCase().includes(q)));

      list.innerHTML = '';
      filtered.forEach(p => list.appendChild(productCard(p)));
      setHidden(empty, filtered.length !== 0);
      setHidden(errBox, true);
    }catch(e){
      console.error(e);
      list.innerHTML = '';
      setHidden(empty, true);
      errBox.textContent = 'Errore caricando i prodotti: ' + (e.message||e);
      setHidden(errBox, false);
    }
  }

  function openProductForm(prod){
    document.getElementById('pm-title').textContent = prod ? 'Modifica prodotto' : 'Nuovo prodotto';
    form.reset();
    fId.value = prod?.id || '';
    fName.value = prod?.name || '';
    fCat.value = prod?.category || '';
    fDesc.value = prod?.description || '';
    fIng.value = prod?.ingredients || '';
    fImg.value = prod?.image_url || '';
    fAvail.value = String(prod?.is_available ?? true);
    fTags.value = Array.isArray(prod?.tags) ? prod.tags.join(', ') : '';
    fOrder.value = prod?.sort_order ?? 0;
    toggleProductModal(true);
    setTimeout(()=>fName.focus(), 10);
  }

  async function submitProduct(e){
    e.preventDefault();
    const id = document.getElementById('p-id').value.trim();
    const id = fId.value.trim();
    const body = {
      name: document.getElementById('p-name').value.trim(),
      category: document.getElementById('p-cat').value.trim() || null,
      image_url: document.getElementById('p-img').value.trim() || null,
      description: document.getElementById('p-desc').value.trim() || null,
      ingredients: document.getElementById('p-ing').value.trim() || null,
      is_available: document.getElementById('p-available').value === 'true',
      tags: document.getElementById('p-tags').value
        ? document.getElementById('p-tags').value.split(',').map(s=>s.trim()).filter(Boolean)
        : [],
      sort_order: Number(document.getElementById('p-order').value || 0)
      name: fName.value.trim(),
      category: fCat.value.trim() || null,
      image_url: fImg.value.trim() || null,
      description: fDesc.value.trim() || null,
      ingredients: fIng.value.trim() || null,
      is_available: fAvail.value === 'true',
      tags: fTags.value ? fTags.value.split(',').map(s=>s.trim()).filter(Boolean) : [],
      sort_order: Number(fOrder.value || 0)
    };
    if(!body.name){ alert('Nome richiesto'); return; }

    if (id) {
      const { error } = await supabase.from('products').update(body).eq('id', id);
      if (error) { alert(error.message); return; }
    } else {
      const { error } = await supabase.from('products').insert(body);
      if (error) { alert(error.message); return; }
    if(!body.name){ alert('Nome richiesto'); fName.focus(); return; }

    btnSave.disabled = true;
    const old = btnSave.textContent;
    btnSave.textContent = 'Salvataggio…';

    try{
      if (id) {
        const { error } = await supabase.from('products').update(body).eq('id', id);
        if (error) throw error;
      } else {
        const { error } = await supabase.from('products').insert(body);
        if (error) throw error;
      }
      toggleProductModal(false);
      await loadProducts();
    }catch(e){
      alert(e.message || e);
    }finally{
      btnSave.disabled = false;
      btnSave.textContent = old;
    }
    toggleProductModal(false);
    await loadProducts();
  }

  async function delProduct(id){
    if(!confirm('Eliminare prodotto?')) return;
    const { error } = await supabase.from('products').delete().eq('id', id);
    if (error) { alert(error.message); return; }
    await loadProducts();
    const btn = document.activeElement;
    if (btn) btn.disabled = true;
    try{
      const { error } = await supabase.from('products').delete().eq('id', id);
      if (error) throw error;
      await loadProducts();
    }catch(e){
      alert(e.message || e);
    }finally{
      if (btn) btn.disabled = false;
    }
  }
  window.delProduct = delProduct;

  // Eventos
  document.getElementById('productForm').addEventListener('submit', submitProduct);
  document.getElementById('search').addEventListener('input', loadProducts);
  // ====== Eventos ======
  document.getElementById('btnNew').addEventListener('click', ()=> openProductForm(null));
  document.getElementById('btnClose').addEventListener('click', ()=> toggleProductModal(false));
  document.getElementById('btnCancel').addEventListener('click', ()=> toggleProductModal(false));
  form.addEventListener('submit', submitProduct);

  // Búsqueda con debounce
  let tSearch;
  qSearch.addEventListener('input', ()=>{
    clearTimeout(tSearch);
    tSearch = setTimeout(loadProducts, 250);
  });

  // Boot
  // ====== Boot ======
  (async function init(){
    const ok = await ensureManager();
    if (!ok) return;
    document.getElementById('app').hidden = false;
    app.hidden = false;
    await loadProducts();
  })();
</script>
</body>
</html>
</html>
