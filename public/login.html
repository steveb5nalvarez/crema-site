<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>CREMA ‚Äì Login</title>
  <link rel="stylesheet" href="/styles.css"/>
  <link rel="icon" type="image/svg+xml" href="https://gelatocrema.com/cdn/shop/files/logo_color.svg?v=1693061670&width=100">
  <link rel="alternate icon" href="/favicon.ico">
  <style>
    :root{
      --ink:#121826; --muted:#667085; --border:rgba(0,0,0,.12);
      --err:#b00020; --ok:#0f9d58;
    }
    body.admin { background: var(--background-1, #fffce3); }
    .login-card { max-width: 460px; margin: 56px auto; padding: 20px; }
    .login-card .row { display:flex; gap:14px; flex-direction:column; }
    .login-card label { font-weight:600; color:#374151; }
    .input { width:100%; padding:12px 14px; border:1px solid var(--border); border-radius:10px; background:#fff; }
    .muted { color:var(--muted); font-size:.9rem; }
    .field { display:flex; flex-direction:column; gap:6px; }
    .pw-wrap { position:relative; }
    .pw-toggle {
      position:absolute; right:8px; top:50%; transform:translateY(-50%);
      background:transparent; border:0; cursor:pointer; padding:6px 8px; color:#475569;
    }
    #msg { min-height:1.25em; color:var(--err); }
    .btn.primary[disabled]{ opacity:.7; cursor:not-allowed; }
    .hint { font-size:.85rem; color:#6b7280; }
  </style>
</head>
<body class="admin">
<header class="nav">
  <div class="nav-inner container">
    <a href="/" class="brand">
      <img src="https://gelatocrema.com/cdn/shop/files/logo_color.svg?v=1693061670&width=100" alt="CREMA" style="height:40px;width:auto">
    </a>
  </div>
</header>

<main class="container admin-main">
  <h1 class="cormorant" style="margin:14px 0 8px">Accedi</h1>
  <section class="card login-card">
    <form id="login-form" class="row" novalidate>
      <div class="field">
        <label for="email">Email</label>
        <input id="email" class="input" type="email" placeholder="nome@crema.it" autocomplete="email" required />
      </div>

      <div class="field">
        <label for="password">Password</label>
        <div class="pw-wrap">
          <input id="password" class="input" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" autocomplete="current-password" required />
          <button type="button" id="pwToggle" class="pw-toggle" aria-label="Mostra/Nascondi password">üëÅÔ∏è</button>
        </div>
      </div>

      <button class="btn primary" id="btnLogin" type="submit">Entra</button>
      <div id="msg" role="alert"></div>
      <p class="muted">Se non hai un account, il <strong>Store Manager</strong> pu√≤ crearne uno per te.</p>
      <p class="hint" id="postLoginHint" style="display:none">Accesso riuscito, reindirizzamento‚Ä¶</p>
    </form>
  </section>
</main>

<script type="module">
  import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm";

  // Supabase client
  const supabase = createClient(
    "https://tcfmeggqhxcnihkmnkqs.supabase.co",
    "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRjZm1lZ2dxaHhjbmloa21ua3FzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTcxOTAzMjUsImV4cCI6MjA3Mjc2NjMyNX0.VYkrvIVWti57W9UOnQcCvywmonWGyrtIT4KAzszbiFs"
  );

  const form   = document.getElementById('login-form');
  const email  = document.getElementById('email');
  const pass   = document.getElementById('password');
  const btn    = document.getElementById('btnLogin');
  const msg    = document.getElementById('msg');
  const hint   = document.getElementById('postLoginHint');
  const pwToggle = document.getElementById('pwToggle');

  // Prefill ultimo email usado
  const lastEmail = localStorage.getItem('crema:lastEmail');
  if (lastEmail) email.value = lastEmail;

  pwToggle.addEventListener('click', () => {
    const isPw = pass.type === 'password';
    pass.type = isPw ? 'text' : 'password';
    pwToggle.textContent = isPw ? 'üôà' : 'üëÅÔ∏è';
  });

  // Redirecci√≥n por rol
  async function redirectByRole(){
    const { data: { user } } = await supabase.auth.getUser();
    if (!user) return;

    const { data: prof, error } = await supabase
      .from('profiles')
      .select('role')
      .eq('user_id', user.id)
      .single();

    if (error || !prof) {
      msg.textContent = "Profilo non trovato. Contatta il manager.";
      btn.disabled = false;
      btn.textContent = 'Entra';
      return;
    }

    hint.style.display = 'block';
    if (prof.role === 'manager') {
      location.href = "/admin.html";      // oppure /admin-shifts.html
    } else {
      location.href = "/employee.html";
    }
  }

  // Si ya hay session activa, redirige
  supabase.auth.getSession().then(({ data: { session } }) => {
    if (session?.user) redirectByRole();
  });

  // Submit (click o Enter)
  form.addEventListener('submit', async (e) => {
    e.preventDefault();
    msg.textContent = '';
    hint.style.display = 'none';

    const emailVal = email.value.trim();
    const passVal  = pass.value;

    if (!emailVal || !passVal) {
      msg.textContent = "Inserisci email e password";
      return;
    }

    btn.disabled = true;
    const oldLabel = btn.textContent;
    btn.textContent = 'Caricamento‚Ä¶';

    try {
      const { error } = await supabase.auth.signInWithPassword({ email: emailVal, password: passVal });
      if (error) {
        msg.textContent = (error.message || 'Credenziali non valide');
        btn.disabled = false;
        btn.textContent = oldLabel;
        return;
      }
      localStorage.setItem('crema:lastEmail', emailVal);
      await redirectByRole();
    } catch (err) {
      console.error(err);
      msg.textContent = 'Errore di rete';
      btn.disabled = false;
      btn.textContent = oldLabel;
    }
  });

  // logout helper (riutilizzabile)
  window.logout = async function(){
    await supabase.auth.signOut();
    location.href = "/login.html";
  };
</script>
</body>
</html>