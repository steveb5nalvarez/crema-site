<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>CREMA – Alta Gelateria</title>
  <link rel="stylesheet" href="/styles.css"/>
  <!-- Favicon -->
<link rel="icon" type="image/svg+xml" href="https://gelatocrema.com/cdn/shop/files/logo_color.svg?v=1693061670&width=100">
<link rel="alternate icon" href="/favicon.ico">

</head>
<body>
  <header class="nav">
  <div class="nav-inner container">
    <!-- Logo -->
    <a href="/" class="brand">
      <img src="https://gelatocrema.com/cdn/shop/files/logo_color.svg?v=1693061670&width=100" 
           alt="CREMA Logo" 
           style="height:50px; width:auto;">
    </a>

    <!-- Pulsanti a destra -->
    <div style="margin-left:auto; display:flex; gap:10px;">
      <button class="btn" onclick="location.href='https://gelatocrema.com/pages/boutiques'">boutiques</button>
      <button class="btn primary" onclick="location.href='/admin.html'">Login</button>
    </div>
  </div>
</header>

  <main class="container">
    <section class="hero">
      <div>
        <h1 class="cormorant">CREMA</h1>
        <p class="badge">ALTA GELATERIA</p>
        <p class="subtitle">Ingredienti selezionati, gusto autentico. Scopri il nostro menu aggiornato in tempo reale.</p>
        <a class="btn primary" href="#menu">Ingredienti</a>
      </div>
      <div class="card">
        <img src="https://qcjcialudtbyyrvndvlq.supabase.co/storage/v1/object/public/crema-images/sf.png" alt="Gelato artigianale" style="border-radius:12px">
      </div>
    </section>
      <section id="menu">
  <h2 class="cormorant">Menu</h2>

  <!-- Barra di ricerca -->
  <section class="container" style="margin-top: var(--spacing-20);">
    <div class="search-wrap">
      <input id="search-input" type="search"
             placeholder="Cerca gusti, ingredienti o categorie… (es. pistacchio salato, sorbetto limone)">
      <button id="search-clear" class="btn" type="button" aria-label="Pulisci ricerca">Pulisci</button>
    </div>
    <div id="search-meta" class="search-meta"></div>
  </section>

  <!-- Filtri per categoria -->
  <div id="filters" style="margin:12px 0"></div>

  <!-- Lista prodotti -->
  <div id="list" class="grid"></div>
</section>
  </main>

  <footer class="footer">
    © <span id="year" ></span> CREMA – Alta Gelateria  
  </footer>

  <div id="modal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <strong id="m-title"></strong>
        <button class="btn" onclick="toggleModal(false)">Chiudi</button>
      </div>
      <div class="modal-body" id="m-body"></div>
    </div>
  </div>

<script>
const API = '/api/products';

// elementi UI
const listEl    = document.getElementById('list');
const filtersEl = document.getElementById('filters');
const qInput    = document.getElementById('search-input');
const qClear    = document.getElementById('search-clear');
const qMeta     = document.getElementById('search-meta');
document.getElementById('year').textContent = new Date().getFullYear();

// dati
let allProducts = [];
let currentCat = null;

// util
function norm(s){
  return (s||'').toString().toLowerCase()
    .normalize('NFD').replace(/[\u0300-\u036f]/g,'');
}
function debounce(fn, ms=150){
  let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a), ms); };
}

// CARD prodotto (senza prezzo)
function card(p){
  const div = document.createElement('div');
  div.className = 'card product';
  div.innerHTML = `
    <img src="${p.image_url || 'https://images.unsplash.com/photo-1551024709-8f23befc6cf7?q=80&w=1200&auto=format&fit=crop'}" alt=""/>
    <h3 style="margin:.5rem 0 0 0">${p.name}</h3>
    <div style="display:flex;justify-content:space-between;align-items:center">
      <small class="badge">${p.category || 'Gelato'}</small>
    </div>
  `;
  div.onclick = () => openProduct(p);
  return div;
}

function toggleModal(state){ document.getElementById('modal').classList[state?'add':'remove']('open'); }
function openProduct(p){
  document.getElementById('m-title').textContent = p.name;
  document.getElementById('m-body').innerHTML = `
    <img src="${p.image_url || 'https://images.unsplash.com/photo-1551024709-8f23befc6cf7?q=80&w=1200&auto=format&fit=crop'}" alt="" style="width:100%;height:240px;object-fit:cover;border-radius:12px"/>
    <p style="margin-top:8px">${p.description || ''}</p>
    <p><strong>Ingredienti:</strong> ${p.ingredients || '—'}</p>
  `;
  toggleModal(true);
}

// filtro combinato: categoria + query testo (AND su parole)
function filterData(data, cat, q){
  const qn = norm(q);
  const tokens = qn.split(/\s+/).filter(Boolean);
  return data.filter(p=>{
    if (cat && p.category !== cat) return false;
    if (!tokens.length) return true;
    const hay = [p.name, p.category, p.description, p.ingredients].map(norm).join(' | ');
    return tokens.every(t => hay.includes(t));
  });
}

function render(rows){
  if (!rows.length){
    listEl.innerHTML = `<div class="empty-state">Nessun risultato. Prova con un altro termine.</div>`;
    return;
  }
  listEl.innerHTML = '';
  rows.forEach(p => listEl.appendChild(card(p)));
}

function renderMeta(q, rowsCount){
  const total = allProducts.length;
  if (!q) qMeta.textContent = `Mostro ${rowsCount}/${total} gusti`;
  else    qMeta.textContent = `“${q}” · ${rowsCount} risultati su ${total}`;
}

// applica ricerca con debounce + sync URL
const applySearch = debounce(()=>{
  const q = qInput.value.trim();
  const rows = filterData(allProducts, currentCat, q);
  render(rows);
  renderMeta(q, rows.length);
  const url = new URL(location.href);
  if (q) url.searchParams.set('q', q); else url.searchParams.delete('q');
  history.replaceState(null, '', url);
}, 150);

async function load(){
  const res = await fetch(API);
  allProducts = await res.json();

  // costruisci filtri categoria
  const cats = [...new Set(allProducts.map(d=>d.category).filter(Boolean))];
  filtersEl.innerHTML = ['Tutti', ...cats].map(c=>`<button class="btn" data-cat="${c}">${c}</button>`).join(' ');
  filtersEl.onclick = (e)=>{
    if (!e.target.dataset.cat) return;
    const sel = e.target.dataset.cat;
    currentCat = (sel === 'Tutti') ? null : sel;
    applySearch(); // riusa la ricerca corrente
  };

  // leggi ?q= dall'URL all'avvio
  const params = new URLSearchParams(location.search);
  const q0 = params.get('q') || '';
  qInput.value = q0;

  const initial = filterData(allProducts, currentCat, q0);
  render(initial);
  renderMeta(q0, initial.length);
}

// events
qInput.addEventListener('input', applySearch);
qClear.addEventListener('click', ()=>{
  qInput.value = '';
  applySearch();
  qInput.focus();
});

load();
</script>

</body>
</html>
