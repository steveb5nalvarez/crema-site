<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>CREMA – Turni & Personale (manager)</title>

  <link rel="stylesheet" href="/styles.css"/>
  <link rel="icon" type="image/svg+xml" href="https://gelatocrema.com/cdn/shop/files/logo_color.svg?v=1693061670&width=100">
  <link rel="alternate icon" href="/favicon.ico">

  <style>
    :root{
      --bg:#fffce3; --card:#ffffff; --ink:#121826; --muted:#667085;
      --primary:#ee7523; --primary-600:#ee7523; --navy:#6a3f24;
      --off:#f8fafc; --accent:#fdecc8; --border:#e5e7eb;
      --danger:#e11d48; --ok:#10b981;
    }
    *{box-sizing:border-box}
    body.admin{ background: var(--bg); color:var(--ink); }
    a{ color:inherit }

    .wrap{max-width:1200px;margin:24px auto;padding:0 16px}
    .card{background:var(--card);border-radius:24px;box-shadow:0 10px 30px rgba(2,6,23,.08);padding:20px}
    h1{margin:8px 0 4px;font-size:clamp(22px,3.2vw,36px)}
    h3{margin:0 0 8px}
    .subtitle{color:var(--muted);font-size:14px;max-width:70ch}

    /* Toolbar */
    .toolbar{display:flex;gap:10px;align-items:center;flex-wrap:wrap;margin:14px 0 10px}
    .btn{background:#111827;color:#fff;border:0;border-radius:999px;padding:10px 14px;font-weight:600;cursor:pointer;white-space:nowrap}
    .btn.secondary{background:var(--primary)}
    .btn.ghost{background:transparent;color:#111827;border:1px solid var(--border)}
    .btn[disabled]{opacity:.6;cursor:not-allowed}
    .switch{display:inline-flex;align-items:center;gap:8px}
    .hint{color:var(--muted);font-size:12px;margin-left:auto}

    /* Tabla turnos */
    .table-wrap{margin-top:14px;border-radius:14px;overflow:auto;border:1px solid var(--border)}
    table{border-collapse:separate;border-spacing:0;width:100%;min-width:980px}
    thead th{position:sticky;top:0;z-index:2;background:var(--primary-600);color:white;font-weight:600;font-size:14px;padding:12px;text-align:left}
    thead th:first-child{background:var(--navy)}
    tbody td{background:#fff;padding:12px;border-bottom:1px solid var(--border);font-size:15px;vertical-align:top}
    tbody tr:last-child td{border-bottom:none}
    tbody td.off{background:var(--accent)}
    .right{text-align:right}

    .emp{display:flex;align-items:center;gap:10px}
    .avatar{--s:34px;width:var(--s);height:var(--s);border-radius:999px;background:linear-gradient(135deg,#ffd3a8,#ee7523);display:grid;place-items:center;font-weight:700;color:#0b1324}
    .emp .name{font-weight:700}
    .emp small{display:block;color:var(--muted);font-size:12px;margin-top:2px}

    td[contenteditable="true"]{outline:none}
    td.edited{box-shadow:inset 0 0 0 2px #f59e0b;border-radius:6px}
    .tag{display:inline-block;padding:.25rem .5rem;border-radius:999px;border:1px solid var(--border);font-size:12px;color:#111827;margin:2px}

    /* Skeleton */
    .sk{display:grid;gap:10px;padding:12px}
    .sk .bar{height:14px;border-radius:999px;background:linear-gradient(90deg,#eee,#f6f6f6,#eee);background-size:200% 100%;animation:s 1.1s linear infinite}
    @keyframes s{0%{background-position:200% 0}100%{background-position:-200% 0}}

    /* status row */
    .status{display:flex;gap:10px;align-items:center;color:#667085;font-size:13px;margin-top:8px}
    .status .dot{width:8px;height:8px;border-radius:999px;background:var(--ok)}
    .status.error .dot{background:var(--danger)}

    /* Personale */
    .grid2{display:grid;grid-template-columns:1fr 1fr;gap:16px}
    @media (max-width:900px){ .grid2{grid-template-columns:1fr} }
    .small{font-size:.9rem;color:#475569}
    .pill{background:#fff;border:1px solid var(--border);border-radius:999px;padding:6px 10px}
    .row{display:flex;gap:10px;flex-wrap:wrap}
    .row .input, .row select { padding:12px 14px; border:1px solid var(--border); border-radius:12px; font-size:16px }
    .row .input:focus, .row select:focus{ outline:2px solid #1118271a }
    .table-mini{width:100%;border-collapse:separate;border-spacing:0}
    .table-mini th, .table-mini td{padding:10px 12px;border-bottom:1px solid var(--border);font-size:14px}
    .badge{display:inline-block;background:#f8fafc;border:1px solid var(--border);border-radius:999px;padding:2px 8px;font-size:12px}

    /* Bottom sheet (Add Employee) */
    .sheet{position:fixed;inset:0;display:none;background:rgba(2,6,23,.4);z-index:999}
    .sheet.open{display:block}
    .sheet .panel{
      position:absolute;left:0;right:0;bottom:0;background:#fff;border-top-left-radius:20px;border-top-right-radius:20px;
      box-shadow:0 -10px 30px rgba(2,6,23,.15);padding:16px 16px 20px;max-height:90vh;overflow:auto
    }
    .sheet .grab{width:44px;height:5px;border-radius:999px;background:#e5e7eb;margin:6px auto 10px}
    .sheet h3{margin:4px 0 10px}
    .seg{display:flex;border:1px solid var(--border);border-radius:999px;overflow:hidden}
    .seg button{flex:1;padding:10px 12px;background:#fff;border:0}
    .seg button.active{background:#111827;color:#fff}
    .field{display:grid;gap:6px;margin:10px 0}
    .field label{font-size:13px;color:#475569}
    .field input, .field select{padding:12px 14px;border:1px solid var(--border);border-radius:12px;font-size:16px}
    .inline{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .muted{color:#6b7280;font-size:12px}
    .err{color:var(--danger);font-size:13px;min-height:1.2em}
    .ok{color:var(--ok);font-size:13px;min-height:1.2em}

    /* FAB mobile */
    .fab{position:fixed;right:16px;bottom:16px;background:var(--primary);color:#fff;border:0;border-radius:999px;
      padding:14px 16px;font-weight:700;box-shadow:0 10px 20px rgba(238,117,35,.35);z-index:998}
    .fab span{font-size:20px;line-height:0;vertical-align:middle;margin-right:6px}

    /* Responsive tweaks */
    @media (max-width:720px){
      .btn{padding:9px 12px;font-size:14px}
      tbody td{padding:10px;font-size:14px}
      .toolbar .hint{flex-basis:100%;margin-left:0}
      .table-wrap{border-radius:12px}
      .card{border-radius:18px}
      .row .input, .row select{flex:1 1 150px}
      /* Evita sticky header dentro de overflow en móvil (iOS glitch) */
      thead th{ position:static; }
    }

    /* Suaviza scroll en iOS y evita repintados costosos */
    .table-wrap{ -webkit-overflow-scrolling: touch; contain: paint; }

    /* Sheet de detalle (empDetail) */
    .sheet2{position:fixed;inset:0;display:none;background:rgba(2,6,23,.45);z-index:1000}
    .sheet2.open{display:block}
    .sheet2 .panel{
      position:absolute;left:0;right:0;bottom:0;background:#fff;
      border-top-left-radius:20px;border-top-right-radius:20px;
      box-shadow:0 -10px 30px rgba(2,6,23,.15);
      max-height:90vh;padding:16px;overflow:auto
    }
    .sheet2 .head{display:flex;align-items:center;gap:10px;margin-bottom:8px}
    .sheet2 .head .title{font-weight:700;font-size:18px;margin-left:auto}
    .sheet2 .body .item{display:flex;justify-content:space-between;gap:10px;padding:10px 0;border-bottom:1px solid var(--border)}
    .sheet2 .body .item:last-child{border-bottom:none}
    .sheet2 .body .when{color:#475569;font-size:14px}

    /* Resaltado temporal al volver a la tabla */
    #tblEmployees tbody tr.hl{outline:2px solid #f59e0b; outline-offset:-2px}

    /* Bloqueo de scroll del body cuando un sheet está abierto */
    body.no-scroll{ overflow:hidden; position:fixed; inset:0; width:100%; }
  </style>
</head>

<body class="admin">
  <header class="nav">
    <div class="nav-inner container">
      <a href="/" class="brand" aria-label="Home CREMA">
        <img src="https://gelatocrema.com/cdn/shop/files/logo_color.svg?v=1693061670&width=100" alt="CREMA" style="height:40px;width:auto">
      </a>
      <div style="margin-left:auto;display:flex;gap:10px;flex-wrap:wrap">
        <button class="btn" onclick="location.href='/index.html'">Sito</button>
        <button class="btn" onclick="location.href='/admin.html'">Prodotti</button>
        <button class="btn" onclick="location.href='/employee.html'">Area dipendente</button>
        <button class="btn secondary" onclick="logout()">Logout</button>
      </div>
    </div>
  </header>

  <!-- FAB mobile -->
  <button class="fab" id="fabAdd"><span>＋</span>Dipendente</button>

  <!-- app hidden finché non validiamo il ruolo -->
  <main class="wrap" id="app" hidden>

    <!-- ====== PERSONALE ====== -->
    <div class="card" id="card-personale">
      <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap">
        <h1 style="margin-right:auto">Personale</h1>
        <button class="btn secondary" id="openSheet">+ Crea</button>
      </div>
      <p class="subtitle">Aggiungi dipendenti. Dopo la creazione puoi programmare turni (anche automatici per mese/anno).</p>

      <div class="grid2">
        <!-- Lista dipendenti e ore mese -->
        <section style="grid-column:1 / -1">
          <div style="display:flex;align-items:center;gap:10px;margin-bottom:8px;flex-wrap:wrap">
            <h3 style="margin-right:auto">Elenco dipendenti</h3>
            <span class="small">Mese corrente: <span class="pill" id="monthLabel"></span></span>
            <button class="btn" id="btnReloadEmp">Ricarica</button>
          </div>
          <div class="table-wrap" style="border-radius:12px">
            <table class="table-mini" id="tblEmployees">
              <thead>
                <tr>
                  <th>Nome</th>
                  <th>Reparto</th>
                  <th>Ruolo</th>
                  <th>Stato</th>
                  <th class="right">Ore mese</th>
                </tr>
              </thead>
              <tbody id="empBody"><tr><td colspan="5" class="small">Caricamento…</td></tr></tbody>
            </table>
          </div>
        </section>
      </div>
    </div>

    <!-- ====== PROGRAMMAZIONE TURNI ====== -->
    <div class="card" style="margin-top:18px">
      <h1>Programmazione turni settimanale</h1>
      <p class="subtitle">Modifica giorno/ora o imposta <b>OFF</b>. La colonna finale mostra il <b>totale ore</b> settimanali.</p>

      <div class="toolbar">
        <label class="switch"><input type="checkbox" id="managerMode" checked> Modalità manager</label>
        <input type="date" id="weekStart" aria-label="Settimana di inizio"/>
        <button class="btn" id="prevW">◀ Settimana prec.</button>
        <button class="btn secondary" id="thisW">Questa settimana</button>
        <button class="btn" id="nextW">Settimana succ. ▶</button>
        <button class="btn" id="saveBtn" disabled>💾 Salva modifiche</button>
        <button class="btn" id="autoMonth">Auto mese</button>
        <button class="btn" id="autoYear">Auto anno</button>
        <span class="hint">Celle: <b>HH:MM-HH:MM</b> o <b>OFF</b>. Doppio clic per alternare.</span>
      </div>

      <div class="table-wrap">
        <table id="schedule" aria-live="polite">
          <thead>
            <tr>
              <th style="min-width:220px">Dipendente</th>
              <th>Lun</th><th>Mar</th><th>Mer</th><th>Gio</th><th>Ven</th><th>Sab</th><th>Dom</th>
              <th class="right">Totale ore</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
        <div id="skel" class="sk" style="display:none">
          <div class="bar" style="width:70%"></div>
          <div class="bar" style="width:55%"></div>
          <div class="bar" style="width:62%"></div>
        </div>
      </div>

      <div class="status" id="status"><span class="dot"></span><span id="statusText">Pronto</span></div>

      <div class="card" style="margin-top:20px">
        <h3>Colleghi di turno</h3>
        <div style="display:flex;gap:12px;align-items:center;margin-bottom:8px">
          <label for="matesDay">Giorno:</label>
          <select id="matesDay">
            <option value="0">Lunedì</option><option value="1">Martedì</option><option value="2">Mercoledì</option>
            <option value="3">Giovedì</option><option value="4">Venerdì</option><option value="5">Sabato</option><option value="6">Domenica</option>
          </select>
        </div>
        <div><strong>Banco</strong>: <span id="mates-banco">—</span></div>
        <div><strong>Laboratorio</strong>: <span id="mates-lab">—</span></div>
      </div>
    </div>
  </main>

  <!-- ====== DETALLE EMPLEADO (sheet) ====== -->
  <div class="sheet2" id="empDetail">
    <div class="panel">
      <div class="head">
        <button class="btn ghost" id="closeEmpDetail" type="button">Chiudi</button>
        <div class="title" id="empDetailTitle">Dettagli</div>
      </div>
      <div class="body">
        <div class="row" style="gap:12px;margin-bottom:10px">
          <div class="avatar" id="empDetailAvatar" style="--s:42px"></div>
          <div class="meta">
            <div class="v" id="empDetailName">—</div>
            <div class="k"><span id="empDetailRole">—</span> · <span class="badge" id="empDetailDep">—</span></div>
          </div>
          <div style="margin-left:auto;text-align:right">
            <div class="k">Ore mese</div>
            <div class="v" id="empDetailHours">0</div>
          </div>
        </div>

        <div class="actions">
          <button class="btn secondary" id="btnAutoMonthEmp">Auto mese</button>
          <button class="btn" id="btnAutoYearEmp">Auto anno</button>
          <button class="btn" id="btnGotoTable">Vai alla tabella</button>
        </div>

        <h3 style="margin-top:6px">Prossimi turni (14 giorni)</h3>
        <div class="list" id="empDetailList"><div class="small">Caricamento…</div></div>
      </div>
    </div>
  </div>

  <!-- Bottom-sheet Add Employee -->
  <div class="sheet" id="sheet">
    <div class="panel">
      <div class="grab" role="presentation"></div>
      <div style="display:flex;align-items:center;gap:10px">
        <h3 style="margin-right:auto">Nuovo dipendente</h3>
        <button class="btn ghost" id="closeSheet">Chiudi</button>
      </div>

      <div class="field">
        <label for="fullName">Nome e cognome</label>
        <input id="fullName" placeholder="Es. Mario Rossi" autocomplete="name">
      </div>

      <div class="field">
        <label for="email">Email</label>
        <input id="email" type="email" placeholder="nome@azienda.it" autocomplete="email">
      </div>

      <div class="field">
        <label for="password">Password</label>
        <div class="inline" style="width:100%">
          <input id="password" type="password" placeholder="Min. 6 caratteri" style="flex:1" autocomplete="new-password">
          <button class="btn ghost" id="togglePwd" type="button">Mostra</button>
        </div>
      </div>

      <div class="field">
        <label>Reparto</label>
        <div class="seg" role="group" aria-label="Reparto">
          <button type="button" data-dep="banco" class="active">Banco</button>
          <button type="button" data-dep="laboratorio">Laboratorio</button>
        </div>
        <input id="department" type="hidden" value="banco">
      </div>

      <div class="field">
        <label for="role">Ruolo</label>
        <input id="role" placeholder="Es. Addetto banco">
      </div>

      <div class="field inline">
        <label class="inline" style="gap:6px"><input type="checkbox" id="autoM"> Auto-programma mese</label>
        <label class="inline" style="gap:6px"><input type="checkbox" id="autoY"> Auto-programma anno</label>
        <span class="muted">Usa la regola oraria predefinita per reparto.</span>
      </div>

      <div class="err" id="emp-err"></div>
      <div class="ok" id="emp-ok"></div>

      <div class="inline" style="justify-content:flex-end;margin-top:6px">
        <button class="btn secondary" id="btnCreateEmp">Crea dipendente</button>
      </div>
    </div>
  </div>

  <script type="module">
    import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm";

    // === Supabase (Anon) ===
    const SUPABASE_URL = "https://tcfmeggqhxcnihkmnkqs.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRjZm1lZ2dxaHhjbmloa21ua3FzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTcxOTAzMjUsImV4cCI6MjA3Mjc2NjMyNX0.VYkrvIVWti57W9UOnQcCvywmonWGyrtIT4KAzszbiFs";
    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // logout del header
    window.logout = async () => { await supabase.auth.signOut(); location.href = "/login.html"; };

    // Guard: solo manager
    async function ensureManager(){
      const { data:{ user } } = await supabase.auth.getUser();
      if(!user){ location.href="/login.html"; return false; }
      const { data: prof, error } = await supabase.from('profiles').select('role, full_name').eq('user_id', user.id).single();
      if(error || !prof){ location.href="/login.html"; return false; }
      if(prof.role !== 'manager'){ location.href="/employee.html"; return false; }
      const brand = document.querySelector('.brand'); if(brand && prof.full_name) brand.title = `Manager: ${prof.full_name}`;
      return true;
    }

    // ======== REFS ========
    const app = document.getElementById('app');

    // Sheet (mobile add)
    const sheet = document.getElementById('sheet');
    const openSheetBtn = document.getElementById('openSheet');
    const closeSheetBtn = document.getElementById('closeSheet');
    const fabAdd = document.getElementById('fabAdd');

    // Personale
    const fullNameEl = document.getElementById('fullName');
    const emailEl = document.getElementById('email');
    const passwordEl = document.getElementById('password');
    const departmentHidden = document.getElementById('department');
    const roleEl = document.getElementById('role');
    const btnCreateEmp = document.getElementById('btnCreateEmp');
    const btnReloadEmp = document.getElementById('btnReloadEmp');
    const empBody = document.getElementById('empBody');
    const monthLabel = document.getElementById('monthLabel');
    const autoM = document.getElementById('autoM');
    const autoY = document.getElementById('autoY');
    const empErr = document.getElementById('emp-err');
    const empOk = document.getElementById('emp-ok');
    const togglePwd = document.getElementById('togglePwd');

    // Turni
    const tbody = document.querySelector('#schedule tbody');
    const skel  = document.getElementById('skel');
    const statusRow = document.getElementById('status');
    const statusText = document.getElementById('statusText');
    const managerMode = document.getElementById('managerMode');
    const saveBtn = document.getElementById('saveBtn');
    const weekStartInp = document.getElementById('weekStart');
    const matesDaySel = document.getElementById('matesDay');
    const matesBanco = document.getElementById('mates-banco');
    const matesLab = document.getElementById('mates-lab');
    const autoMonthBtn = document.getElementById('autoMonth');
    const autoYearBtn = document.getElementById('autoYear');

    // ======== UTILS ========
    const toISO = d => d.toISOString().slice(0,10);
    const addDays = (d,n)=>{const x=new Date(d); x.setDate(x.getDate()+n); return x;};
    const startOfWeek = d => {const x=new Date(d); const w=(x.getDay()+6)%7; x.setDate(x.getDate()-w); x.setHours(0,0,0,0); return x;};
    const range7 = from => Array.from({length:7},(_,i)=>addDays(from,i));
    const hhmm = t => (t||'').slice(0,5);
    const monthRange = (d)=>{ const from = new Date(d.getFullYear(), d.getMonth(), 1); const to = new Date(d.getFullYear(), d.getMonth()+1, 0); return [toISO(from), toISO(to)]; };

    function parseHours(span){
      if(!span || /off/i.test(span)) return 0;
      const m=span.match(/(\d{1,2}):(\d{2})-(\d{1,2}):(\d{2})/);
      if(!m) return 0;
      const s=+m[1]*60+ +m[2]; let e=+m[3]*60+ +m[4]; let diff=e-s; if(diff<0) diff+=1440; return diff/60;
    }
    const initials = name => (name||'').split(/\s+/).map(s=>s[0]).join('').slice(0,2).toUpperCase();
    const empCell = (name,role)=>`<div class="emp"><div class="avatar">${initials(name)}</div><div><div class="name">${name}</div><small>${role||''}</small></div></div>`;

    // ======== BODY SCROLL LOCK ========
    function lockBody(){ document.body.classList.add('no-scroll'); }
    function unlockBody(){ document.body.classList.remove('no-scroll'); }

    // ======== STATO ========
    let employees = [];
    let shifts = [];
    let weekStart = startOfWeek(new Date());
    const edits = new Map(); // `${empId}-${idx}` -> "OFF" | "HH:MM-HH:MM"
    let rpcAvailable = true;
    weekStartInp.value = toISO(weekStart);

    // ======== API ========
    async function getEmployees(){
      const { data, error } = await supabase.from('employees')
        .select('id, user_id, name, role, department, is_active')
        .order('is_active',{ascending:false})
        .order('name',{ascending:true});
      if (error) throw error; return data || [];
    }
    async function getShifts(fromISO, toISOstr){
      const { data, error } = await supabase.from('shifts')
        .select('id, employee_id, date, start_time, end_time, break_minutes, break_paid, off')
        .gte('date', fromISO).lte('date', toISOstr);
      if (error) throw error; return data || [];
    }
    async function saveShiftsBulk(items){
      const { data, error } = await supabase.rpc('upsert_shifts_bulk', { payload: { items } });
      if (error) throw error; return data;
    }

    // --------- Plantillas (bancone/laboratorio) ----------
    function planByDeptWeekday(department, idx){
      const dep = (department||'').toLowerCase();
      if (dep === 'laboratorio') return ['08:30','15:30']; // Lun–Dom
      if (idx <= 4) return ['15:15','23:45'];             // Banco Lun–Ven
      return ['11:00','19:30'];                           // Banco Sab–Dom
    }

    function monthEdges(d){ return [new Date(d.getFullYear(), d.getMonth(), 1), new Date(d.getFullYear(), d.getMonth()+1, 0)]; }
    function yearEdges(y){ return [new Date(y,0,1), new Date(y,11,31)]; }
    function* eachDay(from, to){ const d=new Date(from); d.setHours(0,0,0,0); const end=new Date(to); end.setHours(0,0,0,0); for(; d<=end; d.setDate(d.getDate()+1)) yield new Date(d); }
    function buildBulkForEmployee(emp, fromDate, toDate){
      const out=[]; for(const d of eachDay(fromDate,toDate)){ const idx=(d.getDay()+6)%7; const plan=planByDeptWeekday(emp.department, idx);
        if(!plan){ out.push({employee_id:emp.id,date:toISO(d),off:true}); continue; }
        const [start,end]=plan;
        out.push({employee_id:emp.id,date:toISO(d),start_time:start,end_time:end,break_minutes:0,break_paid:false});
      } return out;
    }
    async function autoAssignMonthFor(targetEmpId=null){
      const now=new Date(); const [from,to]=monthEdges(now);
      const list = targetEmpId ? employees.filter(e=>String(e.id)===String(targetEmpId)) : employees.filter(e=>e.is_active);
      if(!list.length) throw new Error('Nessun dipendente selezionato');
      let items=[]; for(const emp of list){ items=items.concat(buildBulkForEmployee(emp,from,to)); }
      await saveShiftsBulk(items);
    }
    async function autoAssignYearFor(targetEmpId=null){
      const year=weekStart.getFullYear(); const [from,to]=yearEdges(year);
      const list = targetEmpId ? employees.filter(e=>String(e.id)===String(targetEmpId)) : employees.filter(e=>e.is_active);
      if(!list.length) throw new Error('Nessun dipendente selezionato');
      let items=[]; for(const emp of list){ items=items.concat(buildBulkForEmployee(emp,from,to)); }
      await saveShiftsBulk(items);
    }

    // ======== SHEET logic ========
    function openSheet(){ sheet.classList.add('open'); lockBody(); setTimeout(()=>fullNameEl.focus(), 0); }
    function closeSheet(){ sheet.classList.remove('open'); unlockBody(); }
    openSheetBtn.addEventListener('click', openSheet);
    fabAdd.addEventListener('click', openSheet);
    closeSheetBtn.addEventListener('click', closeSheet);
    sheet.addEventListener('click', (e)=>{ if(e.target===sheet) closeSheet(); });

    // reparto segment
    document.querySelectorAll('.seg button').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        document.querySelectorAll('.seg button').forEach(b=>b.classList.remove('active'));
        btn.classList.add('active');
        departmentHidden.value = btn.dataset.dep;
      });
    });

    // toggle password
    togglePwd.addEventListener('click', ()=>{
      const type = passwordEl.type === 'password' ? 'text' : 'password';
      passwordEl.type = type;
      togglePwd.textContent = type==='password' ? 'Mostra' : 'Nascondi';
    });

    // === Crear empleado (server) ===
    async function createEmployee(){
      empErr.textContent=''; empOk.textContent='';
      const full_name = (fullNameEl.value||'').trim();
      const email = (emailEl.value||'').trim();
      const password = passwordEl.value;
      const role = (roleEl.value||'').trim() || null;
      const department = departmentHidden.value || null;

      if(!full_name){ empErr.textContent='Inserisci il nome.'; fullNameEl.focus(); return; }
      if(!email){ empErr.textContent='Inserisci l’email.'; emailEl.focus(); return; }
      if(!password || password.length<6){ empErr.textContent='Password minima 6 caratteri.'; passwordEl.focus(); return; }

      btnCreateEmp.disabled = true; const old=btnCreateEmp.textContent; btnCreateEmp.textContent='Creazione…';
      try{
        const { data:{ session } } = await supabase.auth.getSession();
        const token = session?.access_token;
        if(!token){ location.href='/login.html'; return; }

        const res = await fetch('/api/admin/create-employee', {
          method:'POST',
          headers:{ 'Content-Type':'application/json', 'Authorization': 'Bearer ' + token },
          body: JSON.stringify({ fullName: full_name, email, password, role, department })
        });
        const out = await res.json().catch(()=>null);
        if(!res.ok){ throw new Error((out && (out.error||out.message)) || 'Errore creazione dipendente'); }

        empOk.textContent='Dipendente creato!';
        if (autoM.checked || autoY.checked){
          const list = await getEmployees();
          employees = list;
          if (autoM.checked) await autoAssignMonthFor(null);
          if (autoY.checked) await autoAssignYearFor(null);
        }

        fullNameEl.value=''; emailEl.value=''; passwordEl.value=''; roleEl.value='';
        document.querySelectorAll('.seg button').forEach(b=>b.classList.remove('active'));
        document.querySelector('.seg button[data-dep="banco"]').classList.add('active');
        departmentHidden.value='banco';

        await loadEmployeesMonth();
        setTimeout(closeSheet, 500);
      }catch(e){
        empErr.textContent = e.message || e;
      }finally{
        btnCreateEmp.disabled=false; btnCreateEmp.textContent=old;
      }
    }

    // === Personale: lista + ore mese corrente ===
    function monthLabelText(d) {
      return new Intl.DateTimeFormat('it-IT', { month: 'long', year: 'numeric' }).format(d);
    }

    async function loadEmployeesMonth() {
      empBody.innerHTML = `<tr><td colspan="5" class="small">Caricamento…</td></tr>`;
      const now = new Date();
      monthLabel.textContent = monthLabelText(now);
      const [fromISO, toISOstr] = monthRange(now);

      try {
        const list = await getEmployees();
        const monthShifts = await getShifts(fromISO, toISOstr);

        const hoursByEmp = new Map();
        for (const s of monthShifts) {
          if (s.off) continue;
          const start = s.start_time?.slice(0, 5);
          const end   = s.end_time?.slice(0, 5);
          if (!start || !end) continue;

          let h = parseHours(`${start}-${end}`);
          const paid = (typeof s.break_paid === 'boolean') ? s.break_paid : false;
          const brk  = Number(s.break_minutes || 0);
          if (!paid) h -= brk / 60;
          if (h < 0) h = 0;

          hoursByEmp.set(s.employee_id, (hoursByEmp.get(s.employee_id) || 0) + h);
        }

        empBody.innerHTML = '';
        for (const emp of list) {
          const tr = document.createElement('tr');
          tr.setAttribute('data-id', emp.id);
          tr.style.cursor = 'pointer';

          const rep   = emp.department ? `<span class="badge">${emp.department}</span>` : '—';
          const role  = emp.role || '—';
          const stato = emp.is_active ? '<span class="badge">attivo</span>' : '<span class="badge">non attivo</span>';
          const ore   = Math.round(hoursByEmp.get(emp.id) || 0);

          tr.innerHTML = `
            <td>${emp.name}</td>
            <td>${rep}</td>
            <td>${role}</td>
            <td>${stato}</td>
            <td class="right">${ore}</td>
          `;

          tr.addEventListener('click', () => openEmployeeDetail(emp.id));
          empBody.appendChild(tr);
        }

        if (!empBody.children.length) {
          empBody.innerHTML = `<tr><td colspan="5" class="small">Nessun dipendente.</td></tr>`;
        }
      } catch (e) {
        empBody.innerHTML = `<tr><td colspan="5" class="small" style="color:#b00020">Errore: ${e.message || e}</td></tr>`;
      }
    }

    // ======== TURNI (settimana) ========
    function renderWeek(){
      tbody.innerHTML = '';
      const dayKeys = range7(weekStart).map(d=>toISO(d));

      for (const emp of employees){
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${empCell(emp.name, emp.role)}</td>`;
        let tot = 0;

        dayKeys.forEach((k, idx)=>{
          const dayShifts = shifts.filter(s => String(s.employee_id)===String(emp.id) && String(s.date)===k);
          let cell = 'OFF', sum=0;
          if (dayShifts.length){
            cell = dayShifts.map(s=>{
              if (s.off || !s.start_time || !s.end_time) return 'OFF';
              const line = `${hhmm(s.start_time)}-${hhmm(s.end_time)}`;
              sum += parseHours(line);
              return line;
            }).join('<br>');
          }
          tot += sum;

          const td = document.createElement('td');
          td.dataset.empId = emp.id;
          td.dataset.dayIdx = idx;
          td.setAttribute('data-day-idx', idx);
          td.innerHTML = cell;
          if (cell==='OFF') td.classList.add('off');

          td.contentEditable = managerMode.checked ? 'true' : 'false';
          td.addEventListener('dblclick', ()=>{
            if(!managerMode.checked) return;
            const cur = td.textContent.trim();
            const v = /off/i.test(cur) ? '09:00-18:00' : 'OFF';
            td.textContent = v;
            td.classList.toggle('off', /off/i.test(v));
            markEdited(td);
          });
          td.addEventListener('input', ()=> managerMode.checked && markEdited(td));

          tr.appendChild(td);
        });

        const tdTot = document.createElement('td');
        tdTot.className = 'right';
        tdTot.textContent = Math.round(tot).toString();
        tr.appendChild(tdTot);
        tbody.appendChild(tr);
      }
      [...tbody.querySelectorAll('tr')].forEach(recalcRow);
    }

    function markEdited(td){
      const empId = td.dataset.empId;
      const idx = td.dataset.dayIdx;
      const val = td.textContent.trim();
      edits.set(`${empId}-${idx}`, val);
      td.classList.add('edited'); saveBtn.disabled = false;
      recalcRow(td.closest('tr'));
    }

    function recalcRow(tr){
      const dayTds = [...tr.querySelectorAll('td[data-day-idx]')];
      let tot = 0;
      dayTds.forEach(td => { tot += parseHours(td.textContent.trim()); });
      tr.querySelector('.right').textContent = Math.round(tot).toString();
    }

    function renderMates(){
      const idx = Number(matesDaySel.value)||0;
      const dayISO = toISO(addDays(weekStart, idx));
      const today = shifts.filter(s => String(s.date)===dayISO);
      const banco = [], lab = [];

      for (const s of today){
        const emp = employees.find(e => String(e.id)===String(s.employee_id));
        if (!emp || s.off) continue;
        const line = `<span class="tag"><strong>${emp.name}</strong> ${hhmm(s.start_time)}-${hhmm(s.end_time)}</span>`;
        const dep = (emp.department||'').toLowerCase();
        const forceLab = /^kevin\b/i.test(emp.name) || /^lukshan\b/i.test(emp.name);
        if (forceLab || dep==='laboratorio' || /lab/i.test(emp.role||'')) lab.push(line); else banco.push(line);
      }

      matesBanco.innerHTML = banco.length ? banco.join(' ') : '— nessun turno —';
      matesLab.innerHTML   = lab.length   ? lab.join(' ')   : '— nessun turno —';
    }

    async function saveChanges(){
      if (edits.size===0) return;
      if (!rpcAvailable){ alert("Funzione bulk non disponibile. Contatta l'amministratore."); return; }

      const payload = [];
      edits.forEach((val,key)=>{
        const [empId, idx] = key.split('-');
        const date = toISO(addDays(weekStart, Number(idx)));
        if (/off/i.test(val) || val==='') {
          payload.push({ employee_id: Number(empId), date, off: true });
        } else {
          const m = val.match(/(\d{1,2}):(\d{2})-(\d{1,2}):(\d{2})/);
          if (!m) return;
          payload.push({ employee_id:Number(empId), date, start_time:`${m[1]}:${m[2]}`, end_time:`${m[3]}:${m[4]}` });
        }
      });

      try{
        saveBtn.disabled = true; saveBtn.textContent = 'Salvataggio…';
        statusRow.classList.remove('error'); statusText.textContent = 'Salvataggio in corso…';
        await saveShiftsBulk(payload);
        edits.clear();
        const fromISO = toISO(weekStart);
        const toISOstr = toISO(addDays(weekStart, 6));
        shifts = await getShifts(fromISO, toISOstr);
        renderWeek(); renderMates();
        statusText.textContent = 'Modifiche salvate';
        await loadEmployeesMonth();
      }catch(err){
        console.error(err);
        statusRow.classList.add('error');
        statusText.textContent = 'Errore salvataggio';
        alert('Errore nel salvataggio: ' + (err.message || err));
      }finally{
        saveBtn.textContent = '💾 Salva modifiche';
        saveBtn.disabled = edits.size===0;
      }
    }

    // ======== EVENTI ========
    document.getElementById('prevW').addEventListener('click', async ()=>{
      weekStart = addDays(weekStart, -7); weekStartInp.value = toISO(weekStart);
      await reloadWeek();
    });
    document.getElementById('thisW').addEventListener('click', async ()=>{
      weekStart = startOfWeek(new Date()); weekStartInp.value = toISO(weekStart);
      await reloadWeek();
    });
    document.getElementById('nextW').addEventListener('click', async ()=>{
      weekStart = addDays(weekStart, 7); weekStartInp.value = toISO(weekStart);
      await reloadWeek();
    });
    weekStartInp.addEventListener('change', async ()=>{
      weekStart = startOfWeek(new Date(weekStartInp.value));
      await reloadWeek();
    });
    managerMode.addEventListener('change', ()=>{
      [...tbody.querySelectorAll('td[data-day-idx]')].forEach(td=>{
        td.contentEditable = managerMode.checked ? 'true' : 'false';
      });
    });
    autoMonthBtn.addEventListener('click', async ()=>{
      try{
        const choice = prompt('ID dipendente (vuoto = tutti gli attivi):','');
        if (!confirm('Generare turni automatici per il mese corrente?')) return;
        await autoAssignMonthFor(choice?.trim() || null);
        const fromISO = toISO(weekStart);
        const toISOstr = toISO(addDays(weekStart, 6));
        shifts = await getShifts(fromISO, toISOstr);
        renderWeek(); renderMates();
        await loadEmployeesMonth();
        alert('Turni del mese generati.');
      }catch(e){ alert('Errore Auto mese: ' + (e.message||e)); }
    });
    autoYearBtn.addEventListener('click', async ()=>{
      try{
        const choice = prompt('ID dipendente (vuoto = tutti gli attivi):','');
        if (!confirm(`Generare turni automatici per l'anno ${weekStart.getFullYear()}?`)) return;
        await autoAssignYearFor(choice?.trim() || null);
        const fromISO = toISO(weekStart);
        const toISOstr = toISO(addDays(weekStart, 6));
        shifts = await getShifts(fromISO, toISOstr);
        renderWeek(); renderMates();
        await loadEmployeesMonth();
        alert('Turni dell’anno generati.');
      }catch(e){ alert('Errore Auto anno: ' + (e.message||e)); }
    });
    btnCreateEmp.addEventListener('click', createEmployee);
    btnReloadEmp.addEventListener('click', loadEmployeesMonth);
    saveBtn.addEventListener('click', saveChanges);     // <-- añadido
    matesDaySel.addEventListener('change', renderMates); // <-- añadido

    async function reloadWeek(){
      try{
        skel.style.display = 'block';
        const fromISO = toISO(weekStart);
        const toISOstr = toISO(addDays(weekStart, 6));
        shifts = await getShifts(fromISO, toISOstr);
        renderWeek(); renderMates();
      } finally {
        skel.style.display = 'none';
      }
    }

    // ======== INIT ========
    (async function init(){
      const ok = await ensureManager();
      if(!ok) return;

      app.hidden = false;

      try{
        await supabase.rpc('upsert_shifts_bulk', { payload: { items: [] } });
        rpcAvailable = true;
      } catch {
        rpcAvailable = false;
        saveBtn.style.display = 'none';
        statusRow.classList.add('error');
        statusText.textContent = 'Funzione bulk non disponibile';
      }

      try{
        employees = await getEmployees();
        await reloadWeek();
        await loadEmployeesMonth();
        statusText.textContent = 'Pronto';
      }catch(err){
        console.error(err);
        statusRow.classList.add('error');
        statusText.textContent = 'Errore caricamento';
        alert('Errore caricando dati da Supabase: ' + (err.message || err));
      }
    })();

    // ====== DETALLE EMPLEADO ======
    let currentEmpId = null;
    let empHoursCache = new Map();

    const itDate = (d)=> new Intl.DateTimeFormat('it-IT',{weekday:'long', day:'2-digit', month:'long'}).format(d);
    const pad2 = n => String(n).padStart(2,'0');
    const toISOd = d => `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`;
    function addDays2(d, n){ const x = new Date(d); x.setDate(x.getDate()+n); return x; }

    async function loadUpcomingShifts(empId){
      const from = new Date(); from.setHours(0,0,0,0);
      const to   = addDays2(from, 13);
      const { data, error } = await supabase.from('shifts')
        .select('date,start_time,end_time,off,break_minutes,break_paid')
        .eq('employee_id', empId)
        .gte('date', toISO(from))
        .lte('date', toISO(to));
      if (error) throw error;

      const map = new Map();
      (data||[]).forEach(s => map.set(String(s.date), s));

      const items = [];
      for(let d=new Date(from); d<=to; d.setDate(d.getDate()+1)){
        const iso = toISOd(d);
        const s = map.get(iso);
        if (!s) {
          items.push({ date:new Date(d), off:true });
        } else {
          items.push({
            date:new Date(d),
            off: !!s.off || !s.start_time || !s.end_time,
            start: s.start_time?.slice(0,5),
            end:   s.end_time?.slice(0,5),
            brk:   s.break_minutes||0,
            paid:  !!s.break_paid
          });
        }
      }
      return items;
    }

    function closeEmployeeDetail(){
      document.getElementById('empDetail').classList.remove('open');
      unlockBody();
    }
    document.getElementById('closeEmpDetail').addEventListener('click', closeEmployeeDetail);
    document.getElementById('empDetail').addEventListener('click', (e)=>{
      if(e.target.id==='empDetail') closeEmployeeDetail();
    });

    async function renderDetailList(){
      const listEl = document.getElementById('empDetailList');
      listEl.innerHTML = `<div class="small">Caricamento…</div>`;
      try{
        const items = await loadUpcomingShifts(currentEmpId);
        listEl.innerHTML = items.map(it=>{
          const when = itDate(it.date);
          const body = it.off ? `<span class="badge">OFF</span>` :
            `<strong>${it.start}–${it.end}</strong>${
              it.brk?` <span class="sub">(${it.paid?'pausa pagata':'pausa'} ${it.brk}’)</span>`:''}`;
          return `<div class="item"><div class="when">${when}</div><div>${body}</div></div>`;
        }).join('');
      }catch(e){
        listEl.innerHTML = `<div class="small" style="color:#b00020">Errore: ${e.message||e}</div>`;
      }
    }

    function openEmployeeDetail(empId){
      currentEmpId = empId;
      const emp = employees.find(e => String(e.id)===String(empId));
      if(!emp) return;

      document.getElementById('empDetailName').textContent = emp.name || '—';
      document.getElementById('empDetailRole').textContent = emp.role || '—';
      document.getElementById('empDetailDep').textContent  = emp.department || '—';
      document.getElementById('empDetailAvatar').textContent = (emp.name||'').split(/\s+/).map(s=>s[0]).join('').slice(0,2).toUpperCase();
      document.getElementById('empDetailHours').textContent = Math.round((empHoursCache.get(emp.id)||0));

      document.getElementById('btnAutoMonthEmp').onclick = async ()=>{
        try{ await autoAssignMonthFor(emp.id); await reloadWeek(); await loadEmployeesMonth(); await renderDetailList(); alert('Turni del mese generati.'); }
        catch(e){ alert(e.message||e); }
      };
      document.getElementById('btnAutoYearEmp').onclick = async ()=>{
        try{ await autoAssignYearFor(emp.id); await reloadWeek(); await loadEmployeesMonth(); await renderDetailList(); alert('Turni dell’anno generati.'); }
        catch(e){ alert(e.message||e); }
      };
      document.getElementById('btnGotoTable').onclick = ()=>{
        const row = document.querySelector(`#tblEmployees tbody tr[data-id="${emp.id}"]`);
        if(row){
          row.classList.add('hl');
          document.querySelector('.table-wrap')?.scrollTo({ top: row.offsetTop-60, behavior:'smooth' });
          setTimeout(()=> row.classList.remove('hl'), 2000);
        }
        closeEmployeeDetail();
      };

      renderDetailList();
      document.getElementById('empDetail').classList.add('open');
      lockBody();
    }

    // --- Hook a la tabla para abrir detalle por fila ---
    const _loadEmployeesMonth = loadEmployeesMonth;
    loadEmployeesMonth = async function(){
      await _loadEmployeesMonth();

      empHoursCache = new Map();
      [...document.querySelectorAll('#tblEmployees tbody tr')].forEach(tr=>{
        const id = tr.getAttribute('data-id');
        const oreTd = tr.querySelector('td.right');
        if(id && oreTd){
          const ore = Number(oreTd.textContent||0);
          empHoursCache.set(Number(id), ore);
        }
      });

      document.querySelectorAll('#tblEmployees tbody tr').forEach(tr=>{
        const id = tr.getAttribute('data-id');
        if(!id) return;
        tr.style.cursor='pointer';
        tr.addEventListener('click', ()=> openEmployeeDetail(id));
      });
    };
  </script>
</body>
</html>