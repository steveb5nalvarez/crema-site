<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>CREMA â€“ Turni settimanali (manager)</title>

  <link rel="stylesheet" href="/styles.css"/>
  <link rel="icon" type="image/svg+xml" href="https://gelatocrema.com/cdn/shop/files/logo_color.svg?v=1693061670&width=100">
  <link rel="alternate icon" href="/favicon.ico">

  <style>
    :root{
      --bg:#f1e4b2; --card:#ffffff; --ink:#121826; --muted:#667085;
      --primary:#ee7523; --primary-600:#ee7523; --navy:#6a3f24;
      --off:#f8fafc; --accent:#fdecc8; --border:#e5e7eb;
    }
    body.admin { background: var(--background-1, #fffce3); }
    *{box-sizing:border-box}

    .wrap{max-width:1180px;margin:24px auto;padding:0 16px}
    .card{background:var(--card);border-radius:28px;box-shadow:0 10px 30px rgba(2,6,23,.08);padding:24px 20px 28px}
    h1{margin:8px 0 4px;font-size:clamp(22px,3.2vw,36px)}
    .subtitle{color:var(--muted);font-size:14px;max-width:70ch}

    .toolbar{display:flex;gap:12px;align-items:center;flex-wrap:wrap;margin:14px 0 10px}
    .btn{background:#111827;color:#fff;border:0;border-radius:999px;padding:10px 14px;font-weight:600;cursor:pointer}
    .btn.secondary{background:var(--primary)}
    .btn.danger{background:#b91c1c}
    .btn[disabled]{opacity:.6;cursor:not-allowed}
    .switch{display:inline-flex;align-items:center;gap:8px}
    .hint{color:var(--muted);font-size:12px;margin-left:auto}

    .table-wrap{margin-top:18px;border-radius:16px;overflow:auto;border:1px solid var(--border)}
    table{border-collapse:separate;border-spacing:0;width:100%;min-width:980px}
    thead th{position:sticky;top:0;z-index:3;background:var(--primary-600);color:white;font-weight:600;font-size:14px;padding:14px 12px;text-align:left}
    thead th:first-child{background:var(--navy); left:0; position:sticky; z-index:4}
    tbody td{background:#fff;padding:14px 12px;border-bottom:1px solid var(--border);font-size:15px}
    tbody tr:last-child td{border-bottom:none}
    tbody td.off{background:var(--accent)}
    tbody td:first-child{position:sticky; left:0; z-index:2; background:#fff}
    .right{text-align:right}

    .emp{display:flex;align-items:center;gap:12px}
    .avatar{--s:34px;width:var(--s);height:var(--s);border-radius:999px;background:linear-gradient(135deg,#ffd3a8,#ee7523);display:grid;place-items:center;font-weight:700;color:#0b1324}
    .emp .name{font-weight:700}
    .emp small{display:block;color:var(--muted);font-size:12px;margin-top:2px}

    td[contenteditable="true"]{outline:none}
    td.edited{box-shadow:inset 0 0 0 2px #f59e0b;border-radius:6px}
    .tag{display:inline-block;padding:.25rem .5rem;border-radius:999px;border:1px solid var(--border);font-size:12px;color:#111827;margin:2px}

    /* Skeleton */
    .sk{display:grid;gap:10px}
    .sk .bar{height:14px;border-radius:999px;background:linear-gradient(90deg,#eee,#f6f6f6,#eee);background-size:200% 100%;animation:s 1.1s linear infinite}
    @keyframes s{0%{background-position:200% 0}100%{background-position:-200% 0}}

    /* status row */
    .status{display:flex;gap:10px;align-items:center;color:#667085;font-size:13px;margin-top:8px}
    .status .dot{width:8px;height:8px;border-radius:999px;background:#10b981}
    .status.error .dot{background:#ef4444}

    /* Personale */
    .grid2{display:grid;grid-template-columns:1fr 1fr;gap:16px}
    @media (max-width:900px){ .grid2{grid-template-columns:1fr} }
    .small{font-size:.9rem;color:#475569}
    .pill{background:#fff;border:1px solid var(--border);border-radius:999px;padding:6px 10px}
    .row{display:flex;gap:10px;flex-wrap:wrap}
    .row .input, .row select { padding:10px 12px; border:1px solid var(--border); border-radius:10px; }
    .table-mini{width:100%;border-collapse:separate;border-spacing:0}
    .table-mini th, .table-mini td{padding:10px 12px;border-bottom:1px solid var(--border);font-size:14px}
    .badge{display:inline-block;background:#f8fafc;border:1px solid var(--border);border-radius:999px;padding:2px 8px;font-size:12px}

    /* ===== Mobile-first tweaks ===== */
    @media (max-width: 820px){
      .wrap{margin:14px auto}
      .card{border-radius:20px;padding:18px 14px 22px}
      .toolbar{gap:8px}
      .hint{display:none}
      table{min-width:720px}
      tbody td{padding:12px 10px}
      thead th{padding:12px 10px}
      .btn{padding:10px 12px}
      /* MÃ¡s espacio para tocar celdas */
      td[data-day-idx]{cursor:pointer}
    }

    /* BotÃ³n flotante guardar en mÃ³vil */
    .save-fab{
      position: fixed; inset:auto 16px 16px 16px;
      display:none; gap:10px; align-items:center; justify-content:center;
      background:var(--primary); color:#fff; border:none; border-radius:16px;
      padding:14px 16px; font-weight:700; box-shadow:0 10px 30px rgba(0,0,0,.18);
      z-index:999;
    }
    @media (min-width:821px){ .save-fab{ display:none !important; } }

    /* ====== Modal editor celda (mÃ³vil y desktop) ====== */
    .modal { position:fixed; inset:0; display:none; align-items:center; justify-content:center; background:rgba(0,0,0,.35); padding:16px; z-index:998; }
    .modal.open { display:flex; }
    .modal-content { width:100%; max-width:460px; background:#fff; border-radius:16px; overflow:hidden; }
    .modal-header { display:flex; justify-content:space-between; align-items:center; padding:12px 16px; border-bottom:1px solid rgba(0,0,0,.08); }
    .modal-body { padding:16px; display:grid; gap:12px; }
    .modal-body label{ font-size:.92rem; font-weight:600; color:#334155 }
    .modal-body .row{ display:flex; gap:10px; align-items:center }
    .modal-body input[type="time"], .modal-body input[type="number"]{
      width:100%; padding:10px 12px; border:1px solid var(--border); border-radius:10px;
    }
    .modal-footer{ display:flex; gap:10px; justify-content:flex-end; padding:12px 16px; border-top:1px solid rgba(0,0,0,.08)}
    .modal .switch-l{display:flex;align-items:center;gap:8px}
  </style>
</head>

<body class="admin">
  <header class="nav">
    <div class="nav-inner container">
      <a href="/" class="brand">
        <img src="https://gelatocrema.com/cdn/shop/files/logo_color.svg?v=1693061670&width=100" alt="CREMA" style="height:40px;width:auto">
      </a>
      <div style="margin-left:auto;display:flex;gap:10px">
        <button class="btn" onclick="location.href='/index.html'">Sito</button>
        <button class="btn" onclick="location.href='/admin.html'">Prodotti</button>
        <button class="btn" onclick="location.href='/employee.html'">Area dipendente</button>
        <button class="btn primary" onclick="logout()">Logout</button>
      </div>
    </div>
  </header>

  <!-- app hidden finchÃ© non validiamo il ruolo -->
  <main class="wrap" id="app" hidden>

    <!-- ====== REPARTO PERSONALE ====== -->
    <div class="card" id="card-personale">
      <h1>Personale</h1>
      <p class="subtitle">Aggiungi nuovi dipendenti. Dopo la creazione potrai programmare i turni settimanali.</p>

      <div class="grid2">
        <!-- Form nuovo dipendente -->
        <section>
          <h3 style="margin:0 0 10px">Aggiungi dipendente</h3>
          <div class="row" id="emp-form">
            <input id="fullName" class="input" placeholder="Nome e cognome" style="flex:1 1 220px">
            <input id="email" class="input" placeholder="Email" style="flex:1 1 220px" type="email">
            <input id="password" class="input" placeholder="Password" style="flex:1 1 160px" type="password">
            <select id="department">
              <option value="">Repartoâ€¦</option>
              <option value="banco">Banco</option>
              <option value="laboratorio">Laboratorio</option>
            </select>
            <input id="role" class="input" placeholder="Ruolo (es. Addetto banco)" style="flex:1 1 200px">
            <button class="btn secondary" id="btnCreateEmp">+ Crea</button>
          </div>
          <div class="small" id="emp-msg" style="margin-top:8px"></div>
        </section>

        <!-- Lista dipendenti e ore mese -->
        <section>
          <div style="display:flex;align-items:center;gap:10px;margin-bottom:8px">
            <h3 style="margin:0">Elenco dipendenti</h3>
            <button class="btn" id="btnReloadEmp">Ricarica</button>
            <span class="small" style="margin-left:auto">
              Mese corrente: <span class="pill" id="monthLabel"></span>
            </span>
          </div>
          <div class="table-wrap" style="border-radius:12px">
            <table class="table-mini" id="tblEmployees">
              <thead>
                <tr>
                  <th>Nome</th>
                  <th>Reparto</th>
                  <th>Ruolo</th>
                  <th>Stato</th>
                  <th class="right">Ore mese</th>
                </tr>
              </thead>
              <tbody id="empBody"><tr><td colspan="5" class="small">Caricamentoâ€¦</td></tr></tbody>
            </table>
          </div>
        </section>
      </div>
    </div>

    <!-- ====== PROGRAMMAZIONE TURNI ====== -->
    <div class="card" style="margin-top:18px">
      <h1>Programmazione turni settimanale</h1>
      <p class="subtitle">Il manager puÃ² modificare giorno/ora o impostare <b>OFF</b>. La colonna finale mostra il <b>totale ore</b> settimanali.</p>

      <div class="toolbar">
        <label class="switch"><input type="checkbox" id="managerMode" checked> ModalitÃ  manager</label>
        <input type="date" id="weekStart"/>
        <button class="btn" id="prevW">â—€ Settimana prec.</button>
        <button class="btn secondary" id="thisW">Questa settimana</button>
        <button class="btn" id="nextW">Settimana succ. â–¶</button>
        <button class="btn" id="saveBtn" disabled>ðŸ’¾ Salva modifiche</button>
        <span class="hint">Formato celle: <b>HH:MM-HH:MM</b> o <b>OFF</b>. Doppio clic per alternare OFF.</span>
      </div>

      <div class="table-wrap">
        <table id="schedule" aria-live="polite">
          <thead>
            <tr>
              <th style="min-width:220px">Dipendente</th>
              <th>Lun</th><th>Mar</th><th>Mer</th><th>Gio</th><th>Ven</th><th>Sab</th><th>Dom</th>
              <th class="right">Totale ore</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
        <div id="skel" class="sk" style="padding:14px 12px;display:none">
          <div class="bar" style="width:70%"></div>
          <div class="bar" style="width:55%"></div>
          <div class="bar" style="width:62%"></div>
        </div>
      </div>

      <div class="status" id="status"><span class="dot"></span><span id="statusText">Pronto</span></div>

      <div class="card" style="margin-top:20px">
        <h3>Colleghi di turno</h3>
        <div style="display:flex;gap:12px;align-items:center;margin-bottom:8px">
          <label for="matesDay">Giorno:</label>
          <select id="matesDay">
            <option value="0">LunedÃ¬</option><option value="1">MartedÃ¬</option><option value="2">MercoledÃ¬</option>
            <option value="3">GiovedÃ¬</option><option value="4">VenerdÃ¬</option><option value="5">Sabato</option><option value="6">Domenica</option>
          </select>
        </div>
        <div><strong>Banco</strong>: <span id="mates-banco">â€”</span></div>
        <div><strong>Laboratorio</strong>: <span id="mates-lab">â€”</span></div>
      </div>
    </div>
  </main>

  <!-- FAB guardar mÃ³vil -->
  <button id="saveFab" class="save-fab">ðŸ’¾ Salva modifiche</button>

  <!-- Modal editor de celda -->
  <div id="cellModal" class="modal" aria-hidden="true">
    <div class="modal-content">
      <div class="modal-header">
        <strong>Modifica turno</strong>
        <button class="btn" id="mClose">Chiudi</button>
      </div>
      <div class="modal-body">
        <div class="switch-l">
          <input type="checkbox" id="mOff"> <label for="mOff">Giornata OFF</label>
        </div>
        <div class="row">
          <div style="flex:1">
            <label for="mStart">Inizio</label>
            <input type="time" id="mStart" value="09:00">
          </div>
          <div style="flex:1">
            <label for="mEnd">Fine</label>
            <input type="time" id="mEnd" value="18:00">
          </div>
        </div>
        <small class="small">Suggerimento: i minuti di pausa si gestiscono nella pagina note ore (in arrivo).</small>
      </div>
      <div class="modal-footer">
        <button class="btn" id="mClear">Imposta OFF</button>
        <button class="btn secondary" id="mApply">Applica</button>
      </div>
    </div>
  </div>

  <script type="module">
    import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm";

    // === Supabase ===
    const SUPABASE_URL = "https://tcfmeggqhxcnihkmnkqs.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRjZm1lZ2dxaHhjbmloa21ua3FzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTcxOTAzMjUsImV4cCI6MjA3Mjc2NjMyNX0.VYkrvIVWti57W9UOnQcCvywmonWGyrtIT4KAzszbiFs";
    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // logout del header
    window.logout = async () => { await supabase.auth.signOut(); location.href = "/login.html"; };

    // Guard: solo manager
    async function ensureManager(){
      const { data:{ user } } = await supabase.auth.getUser();
      if(!user){ location.href="/login.html"; return false; }
      const { data: prof, error } = await supabase.from('profiles').select('role, full_name').eq('user_id', user.id).single();
      if(error || !prof){ location.href="/login.html"; return false; }
      if(prof.role !== 'manager'){ location.href="/employee.html"; return false; }
      const brand = document.querySelector('.brand'); if(brand && prof.full_name) brand.title = `Manager: ${prof.full_name}`;
      return true;
    }

    // ======== REFS ========
    const app = document.getElementById('app');

    // Personale
    const fullNameEl = document.getElementById('fullName');
    const emailEl = document.getElementById('email');
    const passwordEl = document.getElementById('password');
    const departmentEl = document.getElementById('department');
    const roleEl = document.getElementById('role');
    const btnCreateEmp = document.getElementById('btnCreateEmp');
    const btnReloadEmp = document.getElementById('btnReloadEmp');
    const empMsg = document.getElementById('emp-msg');
    const empBody = document.getElementById('empBody');
    const monthLabel = document.getElementById('monthLabel');

    // Turni
    const tbody = document.querySelector('#schedule tbody');
    const skel  = document.getElementById('skel');
    const statusRow = document.getElementById('status');
    const statusText = document.getElementById('statusText');
    const managerMode = document.getElementById('managerMode');
    const saveBtn = document.getElementById('saveBtn');
    const saveFab = document.getElementById('saveFab');
    const weekStartInp = document.getElementById('weekStart');
    const matesDaySel = document.getElementById('matesDay');
    const matesBanco = document.getElementById('mates-banco');
    const matesLab = document.getElementById('mates-lab');

    // Modal editor refs
    const cellModal = document.getElementById('cellModal');
    const mClose = document.getElementById('mClose');
    const mApply = document.getElementById('mApply');
    const mClear = document.getElementById('mClear');
    const mStart = document.getElementById('mStart');
    const mEnd = document.getElementById('mEnd');
    const mOff = document.getElementById('mOff');

    // ======== UTILS ========
    const toISO = d => d.toISOString().slice(0,10);
    const addDays = (d,n)=>{const x=new Date(d); x.setDate(x.getDate()+n); return x;};
    const startOfWeek = d => {const x=new Date(d); const w=(x.getDay()+6)%7; x.setDate(x.getDate()-w); x.setHours(0,0,0,0); return x;};
    const range7 = from => Array.from({length:7},(_,i)=>addDays(from,i));
    const hhmm = t => (t||'').slice(0,5);
    const monthRange = (d)=>{ const from = new Date(d.getFullYear(), d.getMonth(), 1); const to = new Date(d.getFullYear(), d.getMonth()+1, 0); return [toISO(from), toISO(to)]; };

    function parseHours(span){
      if(!span || /off/i.test(span)) return 0;
      const m=span.match(/(\d{1,2}):(\d{2})-(\d{1,2}):(\d{2})/);
      if(!m) return 0;
      const s=+m[1]*60+ +m[2]; let e=+m[3]*60+ +m[4]; let diff=e-s; if(diff<0) diff+=1440; return diff/60;
    }
    const initials = name => (name||'').split(/\s+/).map(s=>s[0]).join('').slice(0,2).toUpperCase();
    const empCell = (name,role)=>`<div class="emp"><div class="avatar">${initials(name)}</div><div><div class="name">${name}</div><small>${role||''}</small></div></div>`;

    const isMobile = () => window.matchMedia('(max-width: 820px)').matches;

    // ======== STATO ========
    let employees = [];
    let shifts = [];
    let weekStart = startOfWeek(new Date());
    weekStartInp.value = toISO(weekStart);
    const edits = new Map(); // `${empId}-${idx}` -> "OFF" | "HH:MM-HH:MM"
    let rpcAvailable = true;

    // ======== API ========
    async function getEmployees(){
      const { data, error } = await supabase.from('employees')
        .select('id, user_id, name, role, department, is_active')
        .order('is_active',{ascending:false})
        .order('name',{ascending:true});
      if (error) throw error; return data || [];
    }
    async function getShifts(fromISO, toISOstr){
      const { data, error } = await supabase.from('shifts')
        .select('id, employee_id, date, start_time, end_time, break_minutes, break_paid, off')
        .gte('date', fromISO).lte('date', toISOstr);
      if (error) throw error; return data || [];
    }
    async function saveShiftsBulk(items){
      const { data, error } = await supabase.rpc('upsert_shifts_bulk', { payload: { items } });
      if (error) throw error; return data;
    }

    // === Personale: crea dipendente via server ===
    async function createEmployee(){
      empMsg.textContent = '';
      const full_name = fullNameEl.value.trim();
      const email = emailEl.value.trim();
      const password = passwordEl.value;
      const role = roleEl.value.trim() || null;
      const department = departmentEl.value || null;

      if(!full_name || !email || !password){ empMsg.style.color='#b00020'; empMsg.textContent='Compila nome, email e password.'; return; }

      btnCreateEmp.disabled = true; const old=btnCreateEmp.textContent; btnCreateEmp.textContent='Creazioneâ€¦';
      try{
        const { data:{ session } } = await supabase.auth.getSession();
        const token = session?.access_token;
        if(!token){ location.href='/login.html'; return; }

        const res = await fetch('/api/admin/create-employee', {
          method:'POST',
          headers:{ 'Content-Type':'application/json', 'Authorization': 'Bearer ' + token },
          body: JSON.stringify({ fullName: full_name, email, password, role, department })
        });
        const out = await res.text();
        if(!res.ok){ throw new Error(out || 'Errore creazione dipendente'); }

        empMsg.style.color='#0f9d58';
        empMsg.textContent='Dipendente creato correttamente!';
        fullNameEl.value=''; emailEl.value=''; passwordEl.value=''; roleEl.value=''; departmentEl.value='';
        await loadEmployeesMonth();
      }catch(e){
        empMsg.style.color='#b00020';
        empMsg.textContent = e.message || e;
      }finally{
        btnCreateEmp.disabled=false; btnCreateEmp.textContent=old;
      }
    }

    // === Personale: lista + ore mese corrente ===
    function monthLabelText(d){
      const intl = new Intl.DateTimeFormat('it-IT',{ month:'long', year:'numeric' });
      return intl.format(d);
    }

    async function loadEmployeesMonth(){
      empBody.innerHTML = `<tr><td colspan="5" class="small">Caricamentoâ€¦</td></tr>`;
      const now = new Date();
      monthLabel.textContent = monthLabelText(now);
      const [fromISO, toISOstr] = monthRange(now);

      try{
        const list = await getEmployees();
        const monthShifts = await getShifts(fromISO, toISOstr);

        const hoursByEmp = new Map();
        for(const s of monthShifts){
          if (s.off) continue;
          const start = s.start_time?.slice(0,5);
          const end   = s.end_time?.slice(0,5);
          if(!start || !end) continue;
          let h = parseHours(`${start}-${end}`);
          const paid = (typeof s.break_paid === 'boolean') ? s.break_paid : false;
          const brk = Number(s.break_minutes||0);
          if (!paid) h -= brk/60;
          if (h<0) h=0;
          hoursByEmp.set(s.employee_id, (hoursByEmp.get(s.employee_id)||0) + h);
        }

        empBody.innerHTML = '';
        for(const emp of list){
          const tr = document.createElement('tr');
          const rep = emp.department ? `<span class="badge">${emp.department}</span>` : 'â€”';
          const role = emp.role || 'â€”';
          const stato = emp.is_active ? '<span class="badge">attivo</span>' : '<span class="badge">non attivo</span>';
          const ore = Math.round(hoursByEmp.get(emp.id)||0);
          tr.innerHTML = `
            <td>${emp.name}</td>
            <td>${rep}</td>
            <td>${role}</td>
            <td>${stato}</td>
            <td class="right">${ore}</td>
          `;
          empBody.appendChild(tr);
        }

        if(!empBody.children.length){
          empBody.innerHTML = `<tr><td colspan="5" class="small">Nessun dipendente.</td></tr>`;
        }
      }catch(e){
        empBody.innerHTML = `<tr><td colspan="5" class="small" style="color:#b00020">Errore: ${e.message||e}</td></tr>`;
      }
    }

    // ======== TURNI (settimana) ========
    function renderWeek(){
      tbody.innerHTML = '';
      const dayKeys = range7(weekStart).map(d=>toISO(d));

      for (const emp of employees){
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${empCell(emp.name, emp.role)}</td>`;
        let tot = 0;

        dayKeys.forEach((k, idx)=>{
          const dayShifts = shifts.filter(s => String(s.employee_id)===String(emp.id) && String(s.date)===k);
          let cell = 'OFF', sum=0;
          if (dayShifts.length){
            cell = dayShifts.map(s=>{
              if (s.off || !s.start_time || !s.end_time) return 'OFF';
              const line = `${hhmm(s.start_time)}-${hhmm(s.end_time)}`;
              sum += parseHours(line);
              return line;
            }).join('<br>');
          }
          tot += sum;

          const td = document.createElement('td');
          td.dataset.empId = emp.id;
          td.dataset.dayIdx = idx;
          td.setAttribute('data-day-idx', idx);
          td.innerHTML = cell;
          if (cell==='OFF') td.classList.add('off');

          // Desktop: editable inline; Mobile: modal editor
          if (!isMobile()){
            td.contentEditable = managerMode.checked ? 'true' : 'false';
            td.addEventListener('dblclick', ()=>{
              if(!managerMode.checked) return;
              const cur = td.textContent.trim();
              const v = /off/i.test(cur) ? '09:00-18:00' : 'OFF';
              td.textContent = v;
              td.classList.toggle('off', /off/i.test(v));
              markEdited(td);
            });
            td.addEventListener('input', ()=> managerMode.checked && markEdited(td));
          } else {
            td.addEventListener('click', ()=>{
              if(!managerMode.checked) return;
              openCellEditor(td);
            });
          }

          tr.appendChild(td);
        });

        const tdTot = document.createElement('td');
        tdTot.className = 'right';
        tdTot.textContent = Math.round(tot).toString();
        tr.appendChild(tdTot);
        tbody.appendChild(tr);
      }
      [...tbody.querySelectorAll('tr')].forEach(recalcRow);
    }

    function markEdited(td){
      const empId = td.dataset.empId;
      const idx = td.dataset.dayIdx;
      const val = td.textContent.trim();
      edits.set(`${empId}-${idx}`, val);
      td.classList.add('edited');
      toggleSaveButtons(true);
      recalcRow(td.closest('tr'));
    }

    function recalcRow(tr){
      const dayTds = [...tr.querySelectorAll('td[data-day-idx]')];
      let tot = 0;
      dayTds.forEach(td => { tot += parseHours(td.textContent.trim()); });
      tr.querySelector('.right').textContent = Math.round(tot).toString();
    }

    function renderMates(){
      const idx = Number(matesDaySel.value)||0;
      const dayISO = toISO(addDays(weekStart, idx));
      const today = shifts.filter(s => String(s.date)===dayISO);
      const banco = [], lab = [];

      for (const s of today){
        const emp = employees.find(e => String(e.id)===String(s.employee_id));
        if (!emp || s.off) continue;
        const line = `<span class="tag"><strong>${emp.name}</strong> ${hhmm(s.start_time)}-${hhmm(s.end_time)}</span>`;
        const dep = (emp.department||'').toLowerCase();
        const forceLab = /^kevin\b/i.test(emp.name) || /^lukshan\b/i.test(emp.name);
        if (forceLab || dep==='laboratorio' || /lab/i.test(emp.role||'')) lab.push(line); else banco.push(line);
      }

      matesBanco.innerHTML = banco.length ? banco.join(' ') : 'â€” nessun turno â€”';
      matesLab.innerHTML   = lab.length   ? lab.join(' ')   : 'â€” nessun turno â€”';
    }

    async function saveChanges(){
      if (edits.size===0) return;
      if (!rpcAvailable){ alert("Funzione bulk non disponibile. Contatta l'amministratore."); return; }

      const payload = [];
      edits.forEach((val,key)=>{
        const [empId, idx] = key.split('-');
        const date = toISO(addDays(weekStart, Number(idx)));
        if (/off/i.test(val) || val==='') {
          payload.push({ employee_id: Number(empId), date, off: true });
        } else {
          const m = val.match(/(\d{1,2}):(\d{2})-(\d{1,2}):(\d{2})/);
          if (!m) return;
          payload.push({ employee_id:Number(empId), date, start_time:`${m[1]}:${m[2]}`, end_time:`${m[3]}:${m[4]}` });
        }
      });

      try{
        disableSaves(true, 'Salvataggioâ€¦');
        statusRow.classList.remove('error'); statusText.textContent = 'Salvataggio in corsoâ€¦';
        await saveShiftsBulk(payload);
        edits.clear();
        const fromISO = toISO(weekStart);
        const toISOstr = toISO(addDays(weekStart, 6));
        shifts = await getShifts(fromISO, toISOstr);
        renderWeek(); renderMates();
        statusText.textContent = 'Modifiche salvate';
        await loadEmployeesMonth();
      }catch(err){
        console.error(err);
        statusRow.classList.add('error');
        statusText.textContent = 'Errore salvataggio';
        alert('Errore nel salvataggio: ' + (err.message || err));
      }finally{
        disableSaves(false, 'ðŸ’¾ Salva modifiche');
        toggleSaveButtons(false);
      }
    }

    function disableSaves(disabled, text){
      saveBtn.disabled = disabled;
      if(text) saveBtn.textContent = text;
      saveFab.disabled = disabled;
      if(text) saveFab.textContent = text;
    }
    function toggleSaveButtons(show){
      saveBtn.disabled = !show && edits.size===0;
      if(isMobile()){
        saveFab.style.display = (show || edits.size>0) ? 'flex' : 'none';
      }
    }

    // ===== Modal editor (mÃ³vil + desktop opcional) =====
    let editingTD = null;
    function openCellEditor(td){
      editingTD = td;
      const cur = (td.textContent||'').trim();
      if (/off/i.test(cur) || !cur){
        mOff.checked = true;
        mStart.value = '09:00';
        mEnd.value = '18:00';
      } else {
        mOff.checked = false;
        const m = cur.match(/(\d{1,2}):(\d{2})-(\d{1,2}):(\d{2})/);
        mStart.value = m ? `${m[1].padStart(2,'0')}:${m[2]}` : '09:00';
        mEnd.value   = m ? `${m[3].padStart(2,'0')}:${m[4]}` : '18:00';
      }
      cellModal.classList.add('open');
      cellModal.setAttribute('aria-hidden','false');
    }
    function closeCellEditor(){
      cellModal.classList.remove('open');
      cellModal.setAttribute('aria-hidden','true');
      editingTD = null;
    }
    mClose.addEventListener('click', closeCellEditor);
    mClear.addEventListener('click', ()=>{
      if(!editingTD) return;
      editingTD.textContent = 'OFF';
      editingTD.classList.add('off');
      markEdited(editingTD);
      closeCellEditor();
    });
    mApply.addEventListener('click', ()=>{
      if(!editingTD) return;
      const off = mOff.checked;
      if (off){
        editingTD.textContent = 'OFF';
        editingTD.classList.add('off');
      } else {
        const s = (mStart.value||'09:00').slice(0,5);
        const e = (mEnd.value||'18:00').slice(0,5);
        editingTD.textContent = `${s}-${e}`;
        editingTD.classList.toggle('off', false);
      }
      markEdited(editingTD);
      closeCellEditor();
    });
    cellModal.addEventListener('click', (e)=>{
      if(e.target === cellModal) closeCellEditor();
    });

    // ======== EVENTI ========
    document.getElementById('prevW').addEventListener('click', async ()=>{
      weekStart = addDays(weekStart, -7); weekStartInp.value = toISO(weekStart);
      await reloadWeek();
    });
    document.getElementById('thisW').addEventListener('click', async ()=>{
      weekStart = startOfWeek(new Date()); weekStartInp.value = toISO(weekStart);
      await reloadWeek();
    });
    document.getElementById('nextW').addEventListener('click', async ()=>{
      weekStart = addDays(weekStart, 7); weekStartInp.value = toISO(weekStart);
      await reloadWeek();
    });
    weekStartInp.addEventListener('change', async ()=>{
      weekStart = startOfWeek(new Date(weekStartInp.value));
      await reloadWeek();
    });
    managerMode.addEventListener('change', ()=>{
      // En desktop reactivar contentEditable; en mÃ³vil seguimos con modal
      [...tbody.querySelectorAll('td[data-day-idx]')].forEach(td=>{
        td.contentEditable = (!isMobile() && managerMode.checked) ? 'true' : 'false';
      });
    });
    saveBtn.addEventListener('click', saveChanges);
    saveFab.addEventListener('click', saveChanges);
    matesDaySel.addEventListener('change', renderMates);

    btnCreateEmp.addEventListener('click', createEmployee);
    btnReloadEmp.addEventListener('click', loadEmployeesMonth);

    async function reloadWeek(){
      try{
        skel.style.display = 'block';
        const fromISO = toISO(weekStart);
        const toISOstr = toISO(addDays(weekStart, 6));
        shifts = await getShifts(fromISO, toISOstr);
        renderWeek(); renderMates();
      } finally {
        skel.style.display = 'none';
      }
    }

    // ======== INIT ========
    (async function init(){
      const ok = await ensureManager();
      if(!ok) return;

      app.hidden = false;
      skel.style.display = 'block';

      // RPC avail
      try {
        await supabase.rpc('upsert_shifts_bulk', { payload: { items: [] } });
        rpcAvailable = true;
      } catch {
        rpcAvailable = false;
        saveBtn.style.display = 'none';
        statusRow.classList.add('error');
        statusText.textContent = 'Funzione bulk non disponibile';
      }

      try{
        employees = await getEmployees();
        await reloadWeek();
        await loadEmployeesMonth();
        statusText.textContent = 'Pronto';
      }catch(err){
        console.error(err);
        statusRow.classList.add('error');
        statusText.textContent = 'Errore caricamento';
        alert('Errore caricando dati da Supabase: ' + (err.message || err));
      }finally{
        skel.style.display = 'none';
      }

      // estado inicial botÃ³n mÃ³vil
      toggleSaveButtons(false);
      window.addEventListener('resize', ()=>toggleSaveButtons(edits.size>0));
    })();
  </script>
</body>
</html>