<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>CREMA â€“ Turni (Store Manager)</title>
  <link rel="stylesheet" href="/styles.css"/>
  <link rel="icon" type="image/svg+xml" href="https://gelatocrema.com/cdn/shop/files/logo_color.svg?v=1693061670&width=100">
  <link rel="alternate icon" href="/favicon.ico">
  <style>
    :root{ --bg:#fffce3; --border:#e5e7eb; --primary:#ee7523; }
    body.admin{ background:var(--bg); }
    .wrap{max-width:1100px;margin:22px auto;padding:0 16px}
    .card{background:#fff;border-radius:16px;border:1px solid var(--border);padding:16px 16px 18px;margin-bottom:16px}
    .card h3{margin:.2rem 0 .75rem}
    .row{display:flex;gap:12px;flex-wrap:wrap}
    .row>*{flex:1 1 240px}
    label{font-weight:600;font-size:.95rem}
    input,select{width:100%;padding:10px 12px;border:1px solid var(--border);border-radius:10px}
    .btn{background:#111827;color:#fff;border:0;border-radius:999px;padding:10px 14px;font-weight:600;cursor:pointer}
    .btn.secondary{background:var(--primary)}
    table{width:100%;border-collapse:separate;border-spacing:0}
    th,td{padding:10px;border-bottom:1px solid var(--border);text-align:left}
    th{background:#f9fafb;font-weight:700}
    .pill{display:inline-block;border:1px solid var(--border);border-radius:999px;padding:.25rem .6rem;margin:.15rem;font-size:.85rem}
    .actions{display:flex;gap:8px}
    .muted{color:#667085}
  </style>
</head>
<body class="admin">
<header class="nav">
  <div class="nav-inner container">
    <a href="/" class="brand">
      <img src="https://gelatocrema.com/cdn/shop/files/logo_color.svg?v=1693061670&width=100" alt="CREMA" style="height:40px;width:auto">
    </a>
    <div style="margin-left:auto;display:flex;gap:10px">
      <button class="btn" onclick="location.href='/index.html'">Sito</button>
      <button class="btn" onclick="location.href='/admin-shifts.html'">Turni</button>
      <button class="btn" onclick="location.href='/employee.html'">Area dipendente</button>
      <button class="btn secondary" onclick="logout()">Logout</button>
    </div>
  </div>
</header>

<main class="wrap" id="app" hidden>
  <!-- Alta de dipendente -->
  <section class="card">
    <h3>Nuovo dipendente</h3>
    <div class="row">
      <div><label>Nome</label><input id="firstName" placeholder="Mario"/></div>
      <div><label>Cognome</label><input id="lastName" placeholder="Rossi"/></div>
      <div><label>Email</label><input id="email" type="email" placeholder="mario@azienda.it"/></div>
      <div><label>Password</label><input id="password" type="password" placeholder="Min 8 caratteri"/></div>
    </div>
    <div class="row" style="margin-top:8px">
      <div><label>Ruolo</label>
        <select id="role"><option>Banco</option><option>Laboratorio</option></select>
      </div>
      <div><label>Reparto</label>
        <select id="department"><option value="banco">banco</option><option value="laboratorio">laboratorio</option></select>
      </div>
    </div>
    <div style="margin-top:12px">
      <button class="btn" id="btnCreate">âž• Crea dipendente</button>
      <span class="muted">VerrÃ  creato lâ€™utente Auth, il profilo e la riga in <code>employees</code>.</span>
    </div>
  </section>

  <!-- Caricare busta paga -->
  <section class="card">
    <h3>Busta paga</h3>
    <div class="row">
      <div>
        <label>Dipendente</label>
        <select id="payEmployee"></select>
      </div>
      <div><label>Periodo (inizio)</label><input type="date" id="payStart"/></div>
      <div><label>Periodo (fine)</label><input type="date" id="payEnd"/></div>
      <div><label>Importo netto (EUR)</label><input id="payAmount" type="number" step="0.01" placeholder="0.00"/></div>
    </div>
    <div class="row" style="margin-top:8px">
      <div><input type="file" id="payFile" accept="application/pdf"/></div>
      <div><button class="btn" id="btnUploadPayslip">ðŸ“„ Carica busta paga</button></div>
    </div>
  </section>

  <!-- Approvazioni -->
  <section class="card">
    <h3>Richieste di cambio turno</h3>
    <table id="tblSwaps">
      <thead><tr><th>Richiedente</th><th>Con</th><th>Da</th><th>A</th><th>Messaggio</th><th>Stato</th><th class="actions">Azioni</th></tr></thead>
      <tbody></tbody>
    </table>
  </section>

  <section class="card">
    <h3>Richieste giorno OFF</h3>
    <table id="tblDayOff">
      <thead><tr><th>Dipendente</th><th>Data</th><th>Motivo</th><th>Stato</th><th class="actions">Azioni</th></tr></thead>
      <tbody></tbody>
    </table>
  </section>
</main>

<script type="module">
  import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm";
  const supabase = createClient(
    "https://tcfmeggqhxcnihkmnkqs.supabase.co",
    "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRjZm1lZ2dxaHhjbmloa21ua3FzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTcxOTAzMjUsImV4cCI6MjA3Mjc2NjMyNX0.VYkrvIVWti57W9UOnQcCvywmonWGyrtIT4KAzszbiFs"
  );

  // helpers
  const $ = s => document.querySelector(s);
  const $$ = s => document.querySelectorAll(s);
  const toast = msg => alert(msg);
  window.logout = async () => { await supabase.auth.signOut(); location.href='/index.html'; };

  // gate solo manager
  async function ensureManager(){
    const { data: { user } } = await supabase.auth.getUser();
    if(!user){ location.href='/index.html'; return false; }
    const { data, error } = await supabase.from('profiles').select('role').eq('user_id', user.id).single();
    if(error || !data || data.role!=='manager'){ location.href='/employee.html'; return false; }
    return true;
  }

  // cargar empleados activos en selects (y lista)
  async function loadEmployees(){
    const { data, error } = await supabase.from('employees').select('*').eq('is_active', true).order('name',{ascending:true});
    if(error) throw error;
    const sel = $('#payEmployee'); sel.innerHTML='';
    data.forEach(e=>{
      const opt = document.createElement('option');
      opt.value = e.id; opt.textContent = `${e.name} ${e.role?`(${e.role})`:''}`;
      sel.appendChild(opt);
    });
    return data;
  }

  // crear empleado -> llama a backend /api/admin/create-employee
  async function createEmployee(){
    const first = $('#firstName').value.trim();
    const last  = $('#lastName').value.trim();
    const email = $('#email').value.trim();
    const pass  = $('#password').value;
    const role  = $('#role').value;
    const dept  = $('#department').value;

    if(!first || !last || !email || !pass) return toast('Compila tutti i campi.');
    const fullName = `${first} ${last}`;

    const res = await fetch('/api/admin/create-employee', {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({ fullName, email, password: pass, role, department: dept })
    });
    if(!res.ok){
      const t = await res.text(); toast('Errore creazione: '+t); return;
    }
    toast('Dipendente creato!');
    await loadEmployees();
  }

  // upload payslip
  async function uploadPayslip(){
    const empId = Number($('#payEmployee').value);
    const start = $('#payStart').value; const end = $('#payEnd').value;
    const amt = $('#payAmount').value;
    const file = $('#payFile').files[0];
    if(!empId || !start || !end || !file){ return toast('Compila i campi e seleziona PDF.'); }

    // obtener user_id del employee
    const { data: emp, error: eErr } = await supabase.from('employees').select('id,user_id').eq('id', empId).single();
    if(eErr || !emp?.user_id) return toast('Employee senza user collegato.');

    const filename = `${start.slice(0,7)}.pdf`;
    const path = `${emp.user_id}/${filename}`;

    const up = await supabase.storage.from('payslips').upload(path, file, { upsert:true, contentType:file.type });
    if(up.error) return toast('Errore upload: '+up.error.message);

    const { error: insErr } = await supabase.from('payslips').insert({
      employee_id: empId, period_start: start, period_end: end,
      file_path: path, net_amount: amt || null, currency: 'EUR'
    });
    if(insErr) return toast('Errore DB: '+insErr.message);
    toast('Busta paga caricata!');
  }

  // SWAPS: listar + decidir
  async function loadSwapRequests(){
    const { data, error } = await supabase
      .from('shift_swap_requests')
      .select('id,status,message,created_at, requester:profiles!requester_uid(full_name), with:profiles!with_uid(full_name), s1:shifts!shift_id_from(id,date,start_time,end_time), s2:shifts!shift_id_to(id,date,start_time,end_time)')
      .order('created_at', { ascending:false });
    if(error){ console.error(error); return; }

    const tb = $('#tblSwaps tbody'); tb.innerHTML='';
    data.forEach(r=>{
      const tr = document.createElement('tr');
      const f = s => (s||'').slice(0,5);
      tr.innerHTML = `
        <td>${r.requester?.full_name||'â€”'}</td>
        <td>${r.with?.full_name||'â€”'}</td>
        <td>${r.s1?.date||'â€”'} ${f(r.s1?.start_time)}-${f(r.s1?.end_time)}</td>
        <td>${r.s2?.date||'â€”'} ${f(r.s2?.start_time)}-${f(r.s2?.end_time)}</td>
        <td>${r.message||''}</td>
        <td><span class="pill">${r.status}</span></td>
        <td class="actions">
          <button class="btn" data-act="approve" data-id="${r.id}">Approva</button>
          <button class="btn" data-act="decline" data-id="${r.id}">Declina</button>
        </td>`;
      tb.appendChild(tr);
    });

    tb.querySelectorAll('button').forEach(b=>{
      b.onclick = async () => {
        const approve = b.dataset.act === 'approve';
        const { error } = await supabase.rpc('approve_shift_swap', { _req_id: Number(b.dataset.id), _approve: approve });
        if(error) return toast('Errore: '+error.message);
        toast(approve?'Approvato':'Declinato');
        loadSwapRequests(); // refresh
      };
    });
  }

  // DAY OFF: listar + decidir
  async function loadDayOffRequests(){
    const { data, error } = await supabase
      .from('day_off_requests')
      .select('id,status,date,reason,emp:employees(name),created_at')
      .order('created_at', { ascending:false });
    if(error){ console.error(error); return; }

    const tb = $('#tblDayOff tbody'); tb.innerHTML='';
    data.forEach(r=>{
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${r.emp?.name||'â€”'}</td>
        <td>${r.date}</td>
        <td>${r.reason||''}</td>
        <td><span class="pill">${r.status}</span></td>
        <td class="actions">
          <button class="btn" data-act="approve" data-id="${r.id}">Approva</button>
          <button class="btn" data-act="decline" data-id="${r.id}">Declina</button>
        </td>`;
      tb.appendChild(tr);
    });

    tb.querySelectorAll('button').forEach(b=>{
      b.onclick = async () => {
        const approve = b.dataset.act === 'approve';
        const { error } = await supabase.rpc('approve_day_off', { _req_id: Number(b.dataset.id), _approve: approve });
        if(error) return toast('Errore: '+error.message);
        toast(approve?'Approvato':'Declinato');
        loadDayOffRequests();
      };
    });
  }

  // UI events
  $('#btnCreate').onclick = createEmployee;
  $('#btnUploadPayslip').onclick = uploadPayslip;

  // boot
  (async function init(){
    const ok = await ensureManager();
    if(!ok) return;
    document.getElementById('app').hidden = false;
    await loadEmployees();
    await loadSwapRequests();
    await loadDayOffRequests();
  })();
</script>
</body>
</html>
